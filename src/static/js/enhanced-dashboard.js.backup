/**
 * Enhanced Islamic Dashboard - ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø³Ù„Ø§Ù…ÙŠ Ù…Ø­Ø³Ù†
 * Version 2.0 - Ù…Ø¹ Ù…ÙŠØ²Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© ÙˆÙ…Ø­Ø³Ù†Ø©
 */

class EnhancedIslamicDashboard {
    constructor() {
        this.userLocation = null;
        this.currentPrayerIndex = -1;
        this.prayerTimes = {};
        this.nextPrayerTimer = null;
        
        // Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø³Ù„Ø§Ù…ÙŠØ© Ù…ÙÙŠØ¯Ø©
        this.prayerNames = {
            'fajr': 'Ø§Ù„ÙØ¬Ø±',
            'sunrise': 'Ø§Ù„Ø´Ø±ÙˆÙ‚', 
            'dhuhr': 'Ø§Ù„Ø¸Ù‡Ø±',
            'asr': 'Ø§Ù„Ø¹ØµØ±',
            'maghrib': 'Ø§Ù„Ù…ØºØ±Ø¨',
            'isha': 'Ø§Ù„Ø¹Ø´Ø§Ø¡'
        };

        this.islamicMonths = [
            'Ù…Ø­Ø±Ù…', 'ØµÙØ±', 'Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„', 'Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø¢Ø®Ø±', 'Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø£ÙˆÙ„Ù‰', 'Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø¢Ø®Ø±Ø©',
            'Ø±Ø¬Ø¨', 'Ø´Ø¹Ø¨Ø§Ù†', 'Ø±Ù…Ø¶Ø§Ù†', 'Ø´ÙˆØ§Ù„', 'Ø°Ùˆ Ø§Ù„Ù‚Ø¹Ø¯Ø©', 'Ø°Ùˆ Ø§Ù„Ø­Ø¬Ø©'
        ];

        this.dailyWisdom = [
            {
                text: 'Ø¥Ù† Ù…Ø¹ Ø§Ù„Ø¹Ø³Ø± ÙŠØ³Ø±Ø§Ù‹',
                author: 'Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… - Ø³ÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø­'
            },
            {
                text: 'ÙˆØªÙˆÙƒÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø­ÙŠ Ø§Ù„Ø°ÙŠ Ù„Ø§ ÙŠÙ…ÙˆØª',
                author: 'Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… - Ø³ÙˆØ±Ø© Ø§Ù„ÙØ±Ù‚Ø§Ù†'
            },
            {
                text: 'Ù…Ù† Ø¹Ù…Ù„ ØµØ§Ù„Ø­Ø§Ù‹ Ù…Ù† Ø°ÙƒØ± Ø£Ùˆ Ø£Ù†Ø«Ù‰ ÙˆÙ‡Ùˆ Ù…Ø¤Ù…Ù† ÙÙ„Ù†Ø­ÙŠÙŠÙ†Ù‡ Ø­ÙŠØ§Ø© Ø·ÙŠØ¨Ø©',
                author: 'Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… - Ø³ÙˆØ±Ø© Ø§Ù„Ù†Ø­Ù„'
            },
            {
                text: 'Ø§Ø¹Ù…Ù„ Ù„Ø¯Ù†ÙŠØ§Ùƒ ÙƒØ£Ù†Ùƒ ØªØ¹ÙŠØ´ Ø£Ø¨Ø¯Ø§Ù‹ØŒ ÙˆØ§Ø¹Ù…Ù„ Ù„Ø¢Ø®Ø±ØªÙƒ ÙƒØ£Ù†Ùƒ ØªÙ…ÙˆØª ØºØ¯Ø§Ù‹',
                author: 'Ø¹Ù„ÙŠ Ø¨Ù† Ø£Ø¨ÙŠ Ø·Ø§Ù„Ø¨ Ø±Ø¶ÙŠ Ø§Ù„Ù„Ù‡ Ø¹Ù†Ù‡'
            },
            {
                text: 'Ù…Ù† ØµØ¨Ø± Ø¸ÙØ±',
                author: 'Ø­ÙƒÙ…Ø© Ø¹Ø±Ø¨ÙŠØ©'
            }
        ];

        this.dailyHadith = [
            {
                text: 'Ø¥Ù†Ù…Ø§ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø¨Ø§Ù„Ù†ÙŠØ§Øª ÙˆØ¥Ù†Ù…Ø§ Ù„ÙƒÙ„ Ø§Ù…Ø±Ø¦ Ù…Ø§ Ù†ÙˆÙ‰',
                narrator: 'Ø±ÙˆØ§Ù‡ Ø§Ù„Ø¨Ø®Ø§Ø±ÙŠ ÙˆÙ…Ø³Ù„Ù…'
            },
            {
                text: 'Ø§Ù„Ù…Ø¤Ù…Ù† Ù„Ù„Ù…Ø¤Ù…Ù† ÙƒØ§Ù„Ø¨Ù†ÙŠØ§Ù† ÙŠØ´Ø¯ Ø¨Ø¹Ø¶Ù‡ Ø¨Ø¹Ø¶Ø§Ù‹',
                narrator: 'Ø±ÙˆØ§Ù‡ Ø§Ù„Ø¨Ø®Ø§Ø±ÙŠ ÙˆÙ…Ø³Ù„Ù…'
            },
            {
                text: 'Ù…Ù† ÙƒØ§Ù† ÙŠØ¤Ù…Ù† Ø¨Ø§Ù„Ù„Ù‡ ÙˆØ§Ù„ÙŠÙˆÙ… Ø§Ù„Ø¢Ø®Ø± ÙÙ„ÙŠÙ‚Ù„ Ø®ÙŠØ±Ø§Ù‹ Ø£Ùˆ Ù„ÙŠØµÙ…Øª',
                narrator: 'Ø±ÙˆØ§Ù‡ Ø§Ù„Ø¨Ø®Ø§Ø±ÙŠ ÙˆÙ…Ø³Ù„Ù…'
            },
            {
                text: 'Ù„Ø§ ÙŠØ¤Ù…Ù† Ø£Ø­Ø¯ÙƒÙ… Ø­ØªÙ‰ ÙŠØ­Ø¨ Ù„Ø£Ø®ÙŠÙ‡ Ù…Ø§ ÙŠØ­Ø¨ Ù„Ù†ÙØ³Ù‡',
                narrator: 'Ø±ÙˆØ§Ù‡ Ø§Ù„Ø¨Ø®Ø§Ø±ÙŠ ÙˆÙ…Ø³Ù„Ù…'
            },
            {
                text: 'Ø®ÙŠØ± Ø§Ù„Ù†Ø§Ø³ Ø£Ù†ÙØ¹Ù‡Ù… Ù„Ù„Ù†Ø§Ø³',
                narrator: 'Ø±ÙˆØ§Ù‡ Ø§Ù„Ø·Ø¨Ø±Ø§Ù†ÙŠ'
            }
        ];

        this.islamicEvents = {
            1: { month: 'Ù…Ø­Ø±Ù…', events: ['Ø±Ø£Ø³ Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù‡Ø¬Ø±ÙŠØ©', 'Ø¹Ø§Ø´ÙˆØ±Ø§Ø¡ (10 Ù…Ø­Ø±Ù…)'] },
            2: { month: 'ØµÙØ±', events: ['Ø´Ù‡Ø± ØµÙØ± Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ'] },
            3: { month: 'Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„', events: ['Ø§Ù„Ù…ÙˆÙ„Ø¯ Ø§Ù„Ù†Ø¨ÙˆÙŠ Ø§Ù„Ø´Ø±ÙŠÙ (12 Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„)'] },
            4: { month: 'Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø¢Ø®Ø±', events: ['Ø´Ù‡Ø± Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø¢Ø®Ø± Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ'] },
            5: { month: 'Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø£ÙˆÙ„Ù‰', events: ['Ø´Ù‡Ø± Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ'] },
            6: { month: 'Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø¢Ø®Ø±Ø©', events: ['Ø´Ù‡Ø± Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø¢Ø®Ø±Ø© Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ'] },
            7: { month: 'Ø±Ø¬Ø¨', events: ['Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡ ÙˆØ§Ù„Ù…Ø¹Ø±Ø§Ø¬ (27 Ø±Ø¬Ø¨)', 'Ø´Ù‡Ø± Ø±Ø¬Ø¨ Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ'] },
            8: { month: 'Ø´Ø¹Ø¨Ø§Ù†', events: ['Ù„ÙŠÙ„Ø© Ø§Ù„Ù†ØµÙ Ù…Ù† Ø´Ø¹Ø¨Ø§Ù† (15 Ø´Ø¹Ø¨Ø§Ù†)'] },
            9: { month: 'Ø±Ù…Ø¶Ø§Ù†', events: ['Ø´Ù‡Ø± Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ', 'Ù„ÙŠÙ„Ø© Ø§Ù„Ù‚Ø¯Ø±', 'Ø¹ÙŠØ¯ Ø§Ù„ÙØ·Ø±'] },
            10: { month: 'Ø´ÙˆØ§Ù„', events: ['Ø¹ÙŠØ¯ Ø§Ù„ÙØ·Ø± (1 Ø´ÙˆØ§Ù„)', 'Ø³Øª Ù…Ù† Ø´ÙˆØ§Ù„'] },
            11: { month: 'Ø°Ùˆ Ø§Ù„Ù‚Ø¹Ø¯Ø©', events: ['Ø´Ù‡Ø± Ø°Ùˆ Ø§Ù„Ù‚Ø¹Ø¯Ø© Ø§Ù„Ø­Ø±Ø§Ù…'] },
            12: { month: 'Ø°Ùˆ Ø§Ù„Ø­Ø¬Ø©', events: ['Ù…ÙˆØ³Ù… Ø§Ù„Ø­Ø¬', 'Ø¹ÙŠØ¯ Ø§Ù„Ø£Ø¶Ø­Ù‰ (10 Ø°Ùˆ Ø§Ù„Ø­Ø¬Ø©)', 'Ø£ÙŠØ§Ù… Ø§Ù„ØªØ´Ø±ÙŠÙ‚'] }
        };

        this.init();
    }

    async init() {
        try {
            console.log('ğŸŒŸ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ© Ø§Ù„Ù…Ø­Ø³Ù†Ø©...');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
            this.updateCurrentTime();
            setInterval(() => this.updateCurrentTime(), 1000);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ
            this.updateIslamicCalendar();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø¯ÙŠØ« ÙˆØ§Ù„Ø­ÙƒÙ…Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
            this.updateDailyContent();
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ
            await this.getUserLocation();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            await Promise.all([
                this.updatePrayerTimes(),
                this.updateWeather(),
                this.updateQiblaDirection()
            ]);
            
            // ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ ÙƒÙ„ Ø³Ø§Ø¹Ø©
            setInterval(() => {
                this.updatePrayerTimes();
                this.updateWeather();
            }, 60 * 60 * 1000);
            
            // ØªØ­Ø¯ÙŠØ« Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© ÙˆØ§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
            setInterval(() => this.checkCurrentPrayer(), 1000);
            
            console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ù†Ø¬Ø§Ø­!');
            this.showSuccessMessage('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ù†Ø¬Ø§Ø­!');
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…:', error);
        }
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ
    updateCurrentTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('ar-SA', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        });
        
        const gregorianDate = now.toLocaleDateString('ar-SA', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        this.updateElement('current-time', timeString);
        this.updateElement('gregorian-date', gregorianDate);
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ
    updateIslamicCalendar() {
        try {
            const now = new Date();
            const hijriDate = this.gregorianToHijri(now);
            
            this.updateElement('hijri-date', `${hijriDate.day} ${hijriDate.monthName} ${hijriDate.year}Ù‡Ù€`);
            this.updateElement('hijri-month', hijriDate.monthName);
            this.updateElement('hijri-year', `${hijriDate.year} Ù‡Ù€`);
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©
            const events = this.islamicEvents[hijriDate.month];
            if (events) {
                const eventsList = events.events.join(' â€¢ ');
                this.updateElement('events-list', eventsList);
            }
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ:', error);
        }
    }

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ Ø¥Ù„Ù‰ Ù‡Ø¬Ø±ÙŠ (ØªÙ‚Ø±ÙŠØ¨ÙŠ)
    gregorianToHijri(date) {
        const gYear = date.getFullYear();
        const gMonth = date.getMonth() + 1;
        const gDay = date.getDate();
        
        // Ù…Ø¹Ø§Ø¯Ù„Ø© ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ù„Ù„ØªØ­ÙˆÙŠÙ„
        const hYear = Math.floor((gYear - 622) * 1.030684);
        const hMonth = Math.floor(Math.random() * 12) + 1; // ØªØ¨Ø³ÙŠØ· Ù„Ù„Ø¹Ø±Ø¶
        const hDay = gDay;
        
        return {
            year: hYear + 1444, // ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ø³Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            month: hMonth,
            day: hDay,
            monthName: this.islamicMonths[hMonth - 1]
        };
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙŠÙˆÙ…ÙŠ
    updateDailyContent() {
        const today = new Date().getDate();
        
        // Ø­Ø¯ÙŠØ« Ø§Ù„ÙŠÙˆÙ…
        const hadithIndex = today % this.dailyHadith.length;
        const todayHadith = this.dailyHadith[hadithIndex];
        this.updateElement('daily-hadith', `"${todayHadith.text}"`);
        this.updateElement('hadith-narrator', `- ${todayHadith.narrator}`);
        
        // Ø­ÙƒÙ…Ø© Ø§Ù„ÙŠÙˆÙ…
        const wisdomIndex = today % this.dailyWisdom.length;
        const todayWisdom = this.dailyWisdom[wisdomIndex];
        this.updateElement('daily-wisdom', `"${todayWisdom.text}"`);
        this.updateElement('wisdom-author', `- ${todayWisdom.author}`);
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ
    async getUserLocation() {
        return new Promise((resolve) => {
            // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ø£ÙˆÙ„Ø§Ù‹
            const savedLocation = localStorage.getItem('userLocation');
            if (savedLocation) {
                try {
                    this.userLocation = JSON.parse(savedLocation);
                    this.updateLocationDisplay();
                    resolve(this.userLocation);
                    return;
                } catch (e) {
                    console.warn('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­ÙÙˆØ¸:', e);
                }
            }

            // Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        this.userLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        
                        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
                        try {
                            const cityName = await this.getCityName(
                                this.userLocation.latitude,
                                this.userLocation.longitude
                            );
                            this.userLocation.city = cityName;
                        } catch (error) {
                            this.userLocation.city = 'Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ';
                        }
                        
                        // Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                        localStorage.setItem('userLocation', JSON.stringify(this.userLocation));
                        this.updateLocationDisplay();
                        resolve(this.userLocation);
                    },
                    (error) => {
                        console.warn('ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹:', error);
                        // Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±ÙŠØ§Ø¶ ÙƒÙ…ÙˆÙ‚Ø¹ Ø§ÙØªØ±Ø§Ø¶ÙŠ
                        this.userLocation = {
                            latitude: 24.7136,
                            longitude: 46.6753,
                            city: 'Ø§Ù„Ø±ÙŠØ§Ø¶'
                        };
                        this.updateLocationDisplay();
                        resolve(this.userLocation);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000
                    }
                );
            } else {
                // Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                this.userLocation = {
                    latitude: 24.7136,
                    longitude: 46.6753,
                    city: 'Ø§Ù„Ø±ÙŠØ§Ø¶'
                };
                this.updateLocationDisplay();
                resolve(this.userLocation);
            }
        });
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
    async getCityName(lat, lng) {
        try {
            const response = await fetch(`/api/city-name?lat=${lat}&lng=${lng}`);
            if (response.ok) {
                const data = await response.json();
                return data.city || 'Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ';
            }
        } catch (error) {
            console.warn('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:', error);
        }
        return 'Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ';
    }

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹
    updateLocationDisplay() {
        if (this.userLocation && this.userLocation.city) {
            this.updateElement('current-location', this.userLocation.city);
        }
    }

    // ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©
    async updatePrayerTimes() {
        if (!this.userLocation) return;

        try {
            const today = new Date();
            const formattedDate = `${today.getDate().toString().padStart(2, '0')}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getFullYear()}`;
            
            const response = await fetch(
                `https://api.aladhan.com/v1/timings/${formattedDate}?latitude=${this.userLocation.latitude}&longitude=${this.userLocation.longitude}&method=4`
            );
            
            if (response.ok) {
                const data = await response.json();
                this.prayerTimes = data.data.timings;
                this.displayPrayerTimes();
                this.checkCurrentPrayer();
            } else {
                throw new Error('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©');
            }
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©:', error);
            this.showDefaultPrayerTimes();
        }
    }

    // Ø¹Ø±Ø¶ Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©
    displayPrayerTimes() {
        const prayersList = document.getElementById('prayer-times-list');
        if (!prayersList) return;

        const prayers = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
        const prayerElements = prayers.map(prayer => {
            const arabicName = this.prayerNames[prayer.toLowerCase()];
            const time = this.formatTime(this.prayerTimes[prayer]);
            const remaining = this.getTimeRemaining(this.prayerTimes[prayer]);
            
            return `
                <div class="prayer-time-item" data-prayer="${prayer.toLowerCase()}">
                    <div class="prayer-info">
                        <div class="prayer-name">${arabicName}</div>
                        ${remaining ? `<div class="remaining-time">${remaining}</div>` : ''}
                    </div>
                    <div class="prayer-time">${time}</div>
                </div>
            `;
        }).join('');

        prayersList.innerHTML = prayerElements;
    }

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ù„ØªØ§Ù„ÙŠØ©
    checkCurrentPrayer() {
        const now = new Date();
        const currentTime = now.getHours() * 60 + now.getMinutes();
        
        const prayers = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
        let currentPrayer = -1;
        let nextPrayer = 0;
        
        for (let i = 0; i < prayers.length; i++) {
            const prayerTime = this.parseTime(this.prayerTimes[prayers[i]]);
            const prayerMinutes = prayerTime.hours * 60 + prayerTime.minutes;
            
            if (currentTime >= prayerMinutes) {
                currentPrayer = i;
                nextPrayer = (i + 1) % prayers.length;
            }
        }
        
        // Ø¥Ø°Ø§ Ù„Ù… Ù†ØµÙ„ Ù„Ø£ÙŠ ØµÙ„Ø§Ø© Ø¨Ø¹Ø¯ØŒ ÙØ§Ù„ØµÙ„Ø§Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ù‡ÙŠ Ø§Ù„ÙØ¬Ø±
        if (currentPrayer === -1) {
            nextPrayer = 0; // Ø§Ù„ÙØ¬Ø±
        }
        
        // ØªÙ…ÙŠÙŠØ² Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        const prayerItems = document.querySelectorAll('.prayer-time-item');
        prayerItems.forEach((item, index) => {
            item.classList.remove('current');
            if (index === currentPrayer + 1) { // +1 Ù„Ù„Ø´Ø±ÙˆÙ‚
                item.classList.add('current');
            }
        });
        
        // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
        this.updateNextPrayerInfo(prayers[nextPrayer]);
    }

    // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
    updateNextPrayerInfo(nextPrayerKey) {
        const nextPrayerName = this.prayerNames[nextPrayerKey.toLowerCase()];
        const nextPrayerTime = this.prayerTimes[nextPrayerKey];
        
        this.updateElement('next-prayer-name', nextPrayerName);
        
        // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
        this.startCountdown(nextPrayerTime);
    }

    // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù„ØµÙ„Ø§Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
    startCountdown(prayerTimeStr) {
        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ù† ÙˆØ¬Ø¯
        if (this.nextPrayerTimer) {
            clearInterval(this.nextPrayerTimer);
        }
        
        this.nextPrayerTimer = setInterval(() => {
            const timeRemaining = this.calculateTimeRemaining(prayerTimeStr);
            this.updateElement('time-remaining', 
                `<span class="countdown-timer">${timeRemaining}</span>`);
        }, 1000);
    }

    // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ
    calculateTimeRemaining(prayerTimeStr) {
        const now = new Date();
        const prayerTime = this.parseTime(prayerTimeStr);
        const prayer = new Date(now);
        prayer.setHours(prayerTime.hours, prayerTime.minutes, 0, 0);
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙˆÙ‚Øª Ø§Ù„ØµÙ„Ø§Ø© Ù‚Ø¯ Ù…Ø¶Ù‰ Ø§Ù„ÙŠÙˆÙ…ØŒ Ø§Ø¬Ø¹Ù„Ù‡ Ù„Ù„ØºØ¯
        if (prayer <= now) {
            prayer.setDate(prayer.getDate() + 1);
        }
        
        const diff = prayer - now;
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        
        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¶
        const hoursStr = hours.toString().padStart(2, '0');
        const minutesStr = minutes.toString().padStart(2, '0');
        const secondsStr = seconds.toString().padStart(2, '0');
        
        return `${hoursStr}:${minutesStr}:${secondsStr}`;
    }

    // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„ØµÙ„Ø§Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
    getTimeRemaining(prayerTimeStr) {
        const now = new Date();
        const prayerTime = this.parseTime(prayerTimeStr);
        const prayer = new Date(now);
        prayer.setHours(prayerTime.hours, prayerTime.minutes, 0, 0);
        
        if (prayer < now) {
            prayer.setDate(prayer.getDate() + 1);
        }
        
        const diff = prayer - now;
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        
        if (hours > 0) {
            return `Ø¨Ø¹Ø¯ ${hours} Ø³Ø§Ø¹Ø© Ùˆ ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
        } else if (minutes > 0) {
            return `Ø¨Ø¹Ø¯ ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
        } else {
            return 'Ø§Ù„Ø¢Ù†';
        }
    }

    // ØªØ­ÙˆÙŠÙ„ ÙˆÙ‚Øª Ø§Ù„ØµÙ„Ø§Ø© Ø¥Ù„Ù‰ Ø³Ø§Ø¹Ø§Øª ÙˆØ¯Ù‚Ø§Ø¦Ù‚
    parseTime(timeString) {
        const [hours, minutes] = timeString.split(':').map(Number);
        return { hours, minutes };
    }

    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª Ù„Ù„Ø¹Ø±Ø¶
    formatTime(timeString) {
        const [hours, minutes] = timeString.split(':');
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? 'Ù…' : 'Øµ';
        const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
        return `${displayHour}:${minutes} ${ampm}`;
    }

    // Ø¹Ø±Ø¶ Ù…ÙˆØ§Ù‚ÙŠØª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
    showDefaultPrayerTimes() {
        const prayersList = document.getElementById('prayer-times-list');
        if (prayersList) {
            prayersList.innerHTML = `
                <div class="prayer-time-item">
                    <div class="prayer-name">Ø§Ù„ÙØ¬Ø±</div>
                    <div class="prayer-time">05:30 Øµ</div>
                </div>
                <div class="prayer-time-item">
                    <div class="prayer-name">Ø§Ù„Ø´Ø±ÙˆÙ‚</div>
                    <div class="prayer-time">06:45 Øµ</div>
                </div>
                <div class="prayer-time-item current">
                    <div class="prayer-name">Ø§Ù„Ø¸Ù‡Ø±</div>
                    <div class="prayer-time">12:15 Ù…</div>
                </div>
                <div class="prayer-time-item">
                    <div class="prayer-name">Ø§Ù„Ø¹ØµØ±</div>
                    <div class="prayer-time">03:30 Ù…</div>
                </div>
                <div class="prayer-time-item">
                    <div class="prayer-name">Ø§Ù„Ù…ØºØ±Ø¨</div>
                    <div class="prayer-time">06:45 Ù…</div>
                </div>
                <div class="prayer-time-item">
                    <div class="prayer-name">Ø§Ù„Ø¹Ø´Ø§Ø¡</div>
                    <div class="prayer-time">08:15 Ù…</div>
                </div>
            `;
        }
    }

    // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù‚Ø³
    async updateWeather() {
        if (!this.userLocation) return;

        try {
            const response = await fetch(
                `/api/weather?lat=${this.userLocation.latitude}&lng=${this.userLocation.longitude}`
            );
            
            if (response.ok) {
                const data = await response.json();
                this.displayWeather(data.weather);
            } else {
                throw new Error('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù‚Ø³');
            }
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù‚Ø³:', error);
            this.showDefaultWeather();
        }
    }

    // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ù…Ø­Ø³Ù†Ø©
    displayWeather(weather) {
        const weatherDisplay = document.getElementById('weather-display');
        if (!weatherDisplay) return;

        const weatherIcon = this.getWeatherIcon(weather.icon);
        const windDirection = this.getWindDirection(weather.wind_direction);
        
        weatherDisplay.innerHTML = `
            <div class="weather-main">
                <div class="weather-icon-container">
                    <div class="weather-icon">${weatherIcon}</div>
                    <div class="weather-animation"></div>
                </div>
                <div class="weather-temp-section">
                    <div class="weather-temp">${Math.round(weather.temperature)}Â°</div>
                    <div class="weather-feels-like">ÙŠØ´Ø¹Ø± ÙƒÙ€ ${Math.round(weather.feels_like)}Â°</div>
                </div>
            </div>
            <div class="weather-desc">${weather.description}</div>
            <div class="weather-details">
                <div class="weather-detail">
                    <span class="weather-detail-icon">ğŸ’§</span>
                    <div class="weather-detail-info">
                        <div class="weather-detail-label">Ø§Ù„Ø±Ø·ÙˆØ¨Ø©</div>
                        <div class="weather-detail-value">${weather.humidity}%</div>
                    </div>
                </div>
                <div class="weather-detail">
                    <span class="weather-detail-icon">ğŸŒªï¸</span>
                    <div class="weather-detail-info">
                        <div class="weather-detail-label">Ø§Ù„Ø±ÙŠØ§Ø­</div>
                        <div class="weather-detail-value">${weather.wind_speed} Ù…/Ø« ${windDirection}</div>
                    </div>
                </div>
                <div class="weather-detail">
                    <span class="weather-detail-icon">ğŸ‘ï¸</span>
                    <div class="weather-detail-info">
                        <div class="weather-detail-label">Ø§Ù„Ø±Ø¤ÙŠØ©</div>
                        <div class="weather-detail-value">${weather.visibility} ÙƒÙ…</div>
                    </div>
                </div>
                <div class="weather-detail">
                    <span class="weather-detail-icon">ğŸ“Š</span>
                    <div class="weather-detail-info">
                        <div class="weather-detail-label">Ø§Ù„Ø¶ØºØ·</div>
                        <div class="weather-detail-value">${weather.pressure} Ù‡Ù€.Ø¨</div>
                    </div>
                </div>
            </div>
            <div class="weather-footer">
                <div class="weather-update-time">
                    Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${new Date().toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'})}
                </div>
            </div>
        `;
    }

    // ØªØ­Ø¯ÙŠØ¯ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø±ÙŠØ§Ø­
    getWindDirection(degrees) {
        const directions = ['Ø´', 'Ø´.Ø´.Ù‚', 'Ø´.Ù‚', 'Ø´.Ù‚.Ù‚', 'Ù‚', 'Ø¬.Ù‚.Ù‚', 'Ø¬.Ù‚', 'Ø¬.Ø¬.Ù‚', 'Ø¬', 'Ø¬.Ø¬.Øº', 'Ø¬.Øº', 'Ø¬.Øº.Øº', 'Øº', 'Ø´.Øº.Øº', 'Ø´.Øº', 'Ø´.Ø´.Øº'];
        return directions[Math.round(degrees / 22.5) % 16];
    }
                    <div class="weather-detail-value">${weather.feels_like}Â°</div>
                </div>
            </div>
        `;
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø·Ù‚Ø³
    getWeatherIcon(iconCode) {
        const icons = {
            '01d': 'â˜€ï¸', '01n': 'ğŸŒ™',
            '02d': 'ğŸŒ¤ï¸', '02n': 'â˜ï¸',
            '03d': 'â˜ï¸', '03n': 'â˜ï¸',
            '04d': 'â˜ï¸', '04n': 'â˜ï¸',
            '09d': 'ğŸŒ§ï¸', '09n': 'ğŸŒ§ï¸',
            '10d': 'ğŸŒ¦ï¸', '10n': 'ğŸŒ§ï¸',
            '11d': 'â›ˆï¸', '11n': 'â›ˆï¸',
            '13d': 'ğŸŒ¨ï¸', '13n': 'ğŸŒ¨ï¸',
            '50d': 'ğŸŒ«ï¸', '50n': 'ğŸŒ«ï¸'
        };
        return icons[iconCode] || 'ğŸŒ¤ï¸';
    }

    // Ø¹Ø±Ø¶ Ø·Ù‚Ø³ Ø§ÙØªØ±Ø§Ø¶ÙŠ
    showDefaultWeather() {
        const weatherDisplay = document.getElementById('weather-display');
        if (weatherDisplay) {
            weatherDisplay.innerHTML = `
                <div class="weather-main">
                    <div class="weather-icon">ğŸŒ¤ï¸</div>
                    <div class="weather-temp">25Â°</div>
                </div>
                <div class="weather-desc">ØµØ§ÙÙŠ Ø¬Ø²Ø¦ÙŠØ§Ù‹</div>
                <div class="weather-details">
                    <div class="weather-detail">
                        <div class="weather-detail-label">Ø§Ù„Ø±Ø·ÙˆØ¨Ø©</div>
                        <div class="weather-detail-value">45%</div>
                    </div>
                    <div class="weather-detail">
                        <div class="weather-detail-label">Ø§Ù„Ø¶ØºØ·</div>
                        <div class="weather-detail-value">1013 Ù‡ÙƒØªÙˆØ¨Ø§Ø³ÙƒØ§Ù„</div>
                    </div>
                    <div class="weather-detail">
                        <div class="weather-detail-label">Ø§Ù„Ø±Ø¤ÙŠØ©</div>
                        <div class="weather-detail-value">10 ÙƒÙ…</div>
                    </div>
                    <div class="weather-detail">
                        <div class="weather-detail-label">Ø§Ù„Ø¥Ø­Ø³Ø§Ø³</div>
                        <div class="weather-detail-value">28Â°</div>
                    </div>
                </div>
            `;
        }
    }

    // ØªØ­Ø¯ÙŠØ« Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù‚Ø¨Ù„Ø©
    updateQiblaDirection() {
        if (!this.userLocation) return;

        try {
            // Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„ÙƒØ¹Ø¨Ø© Ø§Ù„Ù…Ø´Ø±ÙØ©
            const kaaba = { lat: 21.4225, lng: 39.8262 };
            const user = { lat: this.userLocation.latitude, lng: this.userLocation.longitude };
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ ÙˆØ§Ù„Ù…Ø³Ø§ÙØ©
            const bearing = this.calculateBearing(user, kaaba);
            const distance = this.calculateDistance(user, kaaba);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙˆØµÙ„Ø©
            const needle = document.getElementById('compass-needle');
            if (needle) {
                needle.style.transform = `rotate(${bearing}deg)`;
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
            this.updateElement('qibla-direction', `${Math.round(bearing)}Â° Ø´Ù…Ø§Ù„ Ø´Ø±Ù‚`);
            this.updateElement('qibla-distance', `${Math.round(distance)} ÙƒÙ… Ù…Ù† Ø§Ù„ÙƒØ¹Ø¨Ø© Ø§Ù„Ù…Ø´Ø±ÙØ©`);
            
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù‚Ø¨Ù„Ø©:', error);
            this.updateElement('qibla-direction', 'Ø´Ù…Ø§Ù„ Ø´Ø±Ù‚');
            this.updateElement('qibla-distance', '--- ÙƒÙ…');
        }
    }

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø¨ÙŠÙ† Ù†Ù‚Ø·ØªÙŠÙ†
    calculateBearing(from, to) {
        const lat1 = from.lat * Math.PI / 180;
        const lat2 = to.lat * Math.PI / 180;
        const deltaLng = (to.lng - from.lng) * Math.PI / 180;
        
        const x = Math.sin(deltaLng) * Math.cos(lat2);
        const y = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(deltaLng);
        
        let bearing = Math.atan2(x, y) * 180 / Math.PI;
        return (bearing + 360) % 360;
    }

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ù†Ù‚Ø·ØªÙŠÙ†
    calculateDistance(from, to) {
        const R = 6371; // Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø£Ø±Ø¶ Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±
        const lat1 = from.lat * Math.PI / 180;
        const lat2 = to.lat * Math.PI / 180;
        const deltaLat = (to.lat - from.lat) * Math.PI / 180;
        const deltaLng = (to.lng - from.lng) * Math.PI / 180;
        
        const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                  Math.cos(lat1) * Math.cos(lat2) *
                  Math.sin(deltaLng/2) * Math.sin(deltaLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        
        return R * c;
    }

    // ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    setLocation(cityName, lat, lng) {
        this.userLocation = {
            latitude: lat,
            longitude: lng,
            city: cityName
        };
        
        // Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        localStorage.setItem('userLocation', JSON.stringify(this.userLocation));
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
        this.updateLocationDisplay();
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        this.updatePrayerTimes();
        this.updateWeather();
        this.updateQiblaDirection();
        
        this.showSuccessMessage(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¥Ù„Ù‰ ${cityName}`);
    }

    // ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø©
    updateElement(id, content) {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = content;
        }
    }

    showSuccessMessage(message) {
        const successMsg = document.getElementById('success-message');
        if (successMsg) {
            successMsg.textContent = message;
            successMsg.classList.add('show');
            
            setTimeout(() => {
                successMsg.classList.remove('show');
            }, 3000);
        }
    }
}

// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆØ§Ù„ØªÙ†Ù‚Ù„
function openLocationModal() {
    const modal = document.getElementById('cityModal');
    if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
}

function closeLocationModal() {
    const modal = document.getElementById('cityModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
}

function selectCity(cityName, lat, lng) {
    if (window.enhancedDashboard) {
        window.enhancedDashboard.setLocation(cityName, lat, lng);
    }
    closeLocationModal();
}

function useCurrentLocation() {
    if (navigator.geolocation) {
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span>â³</span> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...';
        btn.disabled = true;
        
        navigator.geolocation.getCurrentPosition(
            async (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
                try {
                    const response = await fetch(`/api/city-name?lat=${lat}&lng=${lng}`);
                    const data = await response.json();
                    const cityName = data.city || 'Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ';
                    
                    if (window.enhancedDashboard) {
                        window.enhancedDashboard.setLocation(cityName, lat, lng);
                    }
                } catch (error) {
                    if (window.enhancedDashboard) {
                        window.enhancedDashboard.setLocation('Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ', lat, lng);
                    }
                }
                
                closeLocationModal();
                btn.innerHTML = originalText;
                btn.disabled = false;
            },
            (error) => {
                alert('ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¯ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        );
    }
}

function showRegion(region) {
    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚
    const regions = document.querySelectorAll('.region-cities');
    regions.forEach(r => r.classList.remove('active'));
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    const tabs = document.querySelectorAll('.tab-btn');
    tabs.forEach(t => t.classList.remove('active'));
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    document.getElementById(region + '-cities').classList.add('active');
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ù„Ù„Ø²Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
    event.target.classList.add('active');
    
    // Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
    document.getElementById('citySearchInput').value = '';
    filterCities();
}

function filterCities() {
    const searchTerm = document.getElementById('citySearchInput').value.toLowerCase().trim();
    const activeRegion = document.querySelector('.region-cities.active');
    const cityButtons = activeRegion.querySelectorAll('.city-btn');
    
    cityButtons.forEach(btn => {
        const cityText = btn.textContent.toLowerCase();
        if (cityText.includes(searchTerm)) {
            btn.style.display = 'block';
        } else {
            btn.style.display = 'none';
        }
    });
}

// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
function openQuranReader() {
    window.open('/quran', '_blank');
}

function openTasbeh() {
    window.open('/tasbeh', '_blank');
}

function openAzkar() {
    window.open('/azkar', '_blank');
}

function openHadith() {
    window.open('/hadith', '_blank');
}

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡
document.addEventListener('click', (e) => {
    const modal = document.getElementById('cityModal');
    if (e.target === modal) {
        closeLocationModal();
    }
});

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', () => {
    window.enhancedDashboard = new EnhancedIslamicDashboard();
});

// CSS Ù„Ù„Ù…ÙˆØ¯Ø§Ù„ (Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹)
const modalStyles = `
    .location-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        backdrop-filter: blur(5px);
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .modal-content {
        background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%);
        border-radius: 20px;
        padding: 30px;
        max-width: 600px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
        border: 1px solid rgba(255, 215, 0, 0.3);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        color: #FFD700;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .close-modal {
        background: none;
        border: none;
        color: #FFD700;
        font-size: 2rem;
        cursor: pointer;
        padding: 0;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .close-modal:hover {
        background: rgba(255, 215, 0, 0.1);
        transform: rotate(90deg);
    }

    .current-location-btn {
        width: 100%;
        background: linear-gradient(135deg, #2E8B57, #228B22);
        color: white;
        border: none;
        padding: 15px;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .current-location-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(46, 139, 87, 0.4);
    }

    .search-container {
        position: relative;
        margin-bottom: 20px;
    }

    .search-container input {
        width: 100%;
        padding: 15px;
        border: 1px solid rgba(255, 215, 0, 0.3);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 1rem;
        text-align: right;
    }

    .search-container input::placeholder {
        color: rgba(255, 255, 255, 0.6);
    }

    .region-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    .tab-btn {
        flex: 1;
        padding: 12px;
        border: 1px solid rgba(255, 215, 0, 0.3);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.05);
        color: white;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .tab-btn.active {
        background: linear-gradient(135deg, #FFD700, #FFA500);
        color: #0F172A;
        border-color: #FFD700;
    }

    .tab-btn:hover {
        background: rgba(255, 215, 0, 0.1);
    }

    .cities-container {
        max-height: 300px;
        overflow-y: auto;
    }

    .region-cities {
        display: none;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
    }

    .region-cities.active {
        display: grid;
    }

    .city-btn {
        padding: 12px;
        border: 1px solid rgba(255, 215, 0, 0.3);
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
        color: white;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

    .city-btn:hover {
        background: linear-gradient(135deg, #FFD700, #FFA500);
        color: #0F172A;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
    }
`;

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
const styleSheet = document.createElement('style');
styleSheet.textContent = modalStyles;
document.head.appendChild(styleSheet);
