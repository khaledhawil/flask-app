{% extends "base.html" %}

{% block title %}Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… - Holy Quran{% endblock %}

{% block styles %}
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@400;600;700&family=Scheherazade+New:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Cairo', 'Arial', sans-serif;
            background: var(--bg-color);
            margin: 0;
            min-height: 100vh;
            direction: rtl;
            position: relative;
            overflow-x: hidden;
            color: var(--text-color);
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 30% 70%, rgba(34, 197, 94, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 70% 30%, rgba(168, 85, 247, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%);
            z-index: -2;
        }
        
        .islamic-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(255,215,0,0.05) 2px, transparent 2px),
                radial-gradient(circle at 75% 75%, rgba(255,215,0,0.05) 2px, transparent 2px);
            background-size: 60px 60px;
            z-index: -1;
            opacity: 0.8;
        }
        
        [data-theme="light"] .islamic-pattern {
            opacity: 0.3;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: var(--text-color);
            margin-bottom: 40px;
            animation: fadeInDown 1s ease-out;
        }
        
        .header h1 {
            font-family: 'Amiri', serif;
            font-size: 4em;
            margin-bottom: 15px;
            text-shadow: 3px 3px 12px rgba(0,0,0,0.7);
            background: linear-gradient(45deg, #ffd700, #ffed4a, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        [data-theme="light"] .header h1 {
            text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
        }
        
        .bismillah {
            font-family: 'Scheherazade New', serif;
            font-size: 2.5em;
            text-align: center;
            color: #ffd700;
            margin: 30px 0;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.6);
        }
        
        .controls {
            background: var(--card-bg);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }
        
        .search-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 15px 20px;
            border: 2px solid var(--border-color);
            border-radius: 50px;
            background: var(--input-bg);
            color: var(--text-color);
            font-size: 16px;
            font-family: 'Cairo', sans-serif;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255,215,0,0.3);
        }
        
        .search-input::placeholder {
            color: var(--text-muted);
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            background: linear-gradient(45deg, #ffd700, #f59e0b);
            color: #1a1a1a;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Cairo', sans-serif;
            white-space: nowrap;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255,215,0,0.4);
        }
        
        .btn-secondary {
            background: var(--input-bg);
            color: var(--text-color);
        }
        
        .btn-secondary:hover {
            background: var(--card-bg);
        }
        
        .reciter-select {
            padding: 15px 20px;
            border: 2px solid var(--border-color);
            border-radius: 50px;
            background: var(--input-bg);
            color: var(--text-color);
            font-family: 'Cairo', sans-serif;
            cursor: pointer;
        }
        
        .reciter-select option {
            background: var(--input-bg);
            color: var(--text-color);
        }
        
        .surah-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .surah-card {
            background: var(--card-bg);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .surah-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #ffd700, #f59e0b);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .surah-card:hover::before {
            transform: scaleX(1);
        }
        
        .surah-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(255,215,0,0.2);
            border-color: rgba(255,215,0,0.5);
        }
        
        .surah-number {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(45deg, #ffd700, #f59e0b);
            color: #1a1a1a;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        .surah-name {
            font-family: 'Amiri', serif;
            font-size: 1.8em;
            color: #ffd700;
            margin: 10px 0;
            font-weight: 700;
        }
        
        .surah-english {
            color: rgba(255,255,255,0.9);
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        
        .surah-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: rgba(255,255,255,0.7);
            font-size: 0.9em;
            margin-top: 15px;
        }
        
        .audio-icon {
            color: #ffd700;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .audio-icon:hover {
            color: #f59e0b;
            transform: scale(1.1);
        }
        
        .surah-content {
            display: none;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
            border: 1px solid rgba(255,215,0,0.2);
        }
        
        .surah-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,215,0,0.2);
        }
        
        .surah-title {
            font-family: 'Amiri', serif;
            font-size: 3em;
            color: #ffd700;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.6);
            margin-bottom: 10px;
        }
        
        .bismillah-verse {
            font-family: 'Scheherazade New', serif;
            font-size: 2.5em;
            text-align: center;
            color: #ffd700;
            margin: 30px 0;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.6);
            padding: 20px;
            background: rgba(255,215,0,0.1);
            border-radius: 15px;
            border: 1px solid rgba(255,215,0,0.2);
        }
        
        .ayah-container {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            border-left: 4px solid #ffd700;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .ayah-container:hover {
            background: rgba(255,255,255,0.1);
            transform: translateX(-5px);
        }
        
        .ayah-container.playing {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(16, 185, 129, 0.15));
            border-left: 4px solid #22c55e;
            box-shadow: 0 0 25px rgba(34, 197, 94, 0.4);
            transform: translateX(-8px);
            animation: pulseGlow 2s infinite;
        }
        
        .ayah-container.playing .ayah-text {
            color: #f0fdf4;
            text-shadow: 0 0 10px rgba(34, 197, 94, 0.3);
        }
        
        .ayah-container.playing .ayah-number {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.5);
        }
        
        @keyframes pulseGlow {
            0%, 100% {
                box-shadow: 0 0 25px rgba(34, 197, 94, 0.4);
            }
            50% {
                box-shadow: 0 0 35px rgba(34, 197, 94, 0.6);
            }
        }
        
        .ayah-text {
            font-family: 'Scheherazade New', serif;
            font-size: 1.8em;
            line-height: 2;
            color: white;
            margin-bottom: 15px;
            text-align: justify;
            padding-right: 40px;
        }
        
        .ayah-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ayah-number {
            background: linear-gradient(45deg, #ffd700, #f59e0b);
            color: #1a1a1a;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            font-family: 'Amiri', serif;
        }
        
        .btn-icon {
            background: rgba(34, 197, 94, 0.8);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .btn-icon:hover {
            background: rgba(34, 197, 94, 1);
            transform: translateY(-2px);
        }
        
        .btn-icon.playing {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            animation: pulsePlay 1.5s infinite;
        }
        
        .btn-icon.playing i {
            color: white;
        }
        
        @keyframes pulsePlay {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
        
        .loading {
            text-align: center;
            color: rgba(255,255,255,0.7);
            padding: 40px;
            font-size: 1.2em;
        }
        
        .loading i {
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        .floating-audio {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 15px 20px;
            color: white;
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,215,0,0.2);
            display: none;
            direction: ltr;
            z-index: 1000;
        }
        
        .floating-audio.show {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .audio-info {
            flex: 1;
        }
        
        .audio-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .audio-subtitle {
            font-size: 12px;
            color: rgba(255,255,255,0.7);
        }
        
        .audio-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .audio-controls button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 5px;
            transition: color 0.3s ease;
        }
        
        .audio-controls button:hover {
            color: #ffd700;
        }
        
        .audio-controls button.auto-play-active {
            color: #22c55e;
            background: rgba(34, 197, 94, 0.2);
            border-radius: 5px;
        }
        
        .audio-controls button.auto-play-active:hover {
            color: #16a34a;
        }
        
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2.5em;
            }
            
            .bismillah {
                font-size: 1.8em;
            }
            
            .search-section {
                flex-direction: column;
            }
            
            .surah-grid {
                grid-template-columns: 1fr;
            }
            
            .floating-audio {
                left: 10px;
                right: 10px;
                bottom: 10px;
            }
            
            .ayah-text {
                font-size: 1.5em;
            }
        }

        /* Bookmark and User Data Styles */
        .ayah-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .bookmark-btn {
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid rgba(255, 215, 0, 0.5);
            color: #ffd700;
            padding: 6px 10px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .bookmark-btn:hover {
            background: rgba(255, 215, 0, 0.3);
            border-color: #ffd700;
            transform: scale(1.05);
        }

        .bookmark-btn.bookmarked {
            background: linear-gradient(45deg, #ffd700, #f59e0b);
            color: #1a1a1a;
            border-color: #ffd700;
        }

        .bookmarks-section {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }

        .bookmarks-section h3 {
            color: #ffd700;
            margin-bottom: 15px;
            font-family: 'Amiri', serif;
        }

        .bookmarks-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .bookmark-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .bookmark-item:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: translateX(-5px);
        }

        .btn-remove {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: #ef4444;
            padding: 4px 8px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-remove:hover {
            background: rgba(239, 68, 68, 0.8);
            color: white;
        }

        .ayah.highlighted {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.3), rgba(255, 215, 0, 0.1));
            border-left: 4px solid #ffd700;
            padding-left: 15px;
            animation: highlightPulse 3s ease-in-out;
        }

        @keyframes highlightPulse {
            0%, 100% {
                background: linear-gradient(90deg, rgba(255, 215, 0, 0.3), rgba(255, 215, 0, 0.1));
            }
            50% {
                background: linear-gradient(90deg, rgba(255, 215, 0, 0.5), rgba(255, 215, 0, 0.2));
            }
        }

        .message {
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Reading Progress Indicators */
        .ayah.reading-progress {
            position: relative;
        }

        .ayah.reading-progress::before {
            content: 'âœ“';
            position: absolute;
            left: -30px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--success-color);
            font-weight: bold;
            font-size: 18px;
        }

        /* Dark theme adjustments for user data features */
        [data-theme="dark"] .bookmark-item {
            background: rgba(255, 255, 255, 0.05);
        }

        [data-theme="dark"] .bookmark-item:hover {
            background: rgba(255, 215, 0, 0.15);
        }

        /* Light theme adjustments */
        [data-theme="light"] .bookmark-btn {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
            color: var(--primary-color);
        }

        [data-theme="light"] .bookmark-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: var(--primary-color);
        }

        [data-theme="light"] .bookmark-item {
            background: rgba(0, 0, 0, 0.05);
        }

        [data-theme="light"] .bookmark-item:hover {
            background: rgba(59, 130, 246, 0.1);
        }
    </style>
{% endblock %}

{% block content %}
    <div class="islamic-pattern"></div>
        <div class="header">
            <h1>Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</h1>
            <p style="color: rgba(255,255,255,0.8); font-size: 1.3em;">The Holy Quran - Complete Digital Experience</p>
        </div>

        <div class="bismillah">
            Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù
        </div>

        <div class="controls">
            <div class="search-section">
                <input type="text" id="searchInput" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³ÙˆØ±Ø©... Search for Surah...">
                <button class="btn" onclick="searchSurahs()">
                    <i class="fas fa-search"></i> Ø¨Ø­Ø«
                </button>
                <button class="btn btn-secondary" onclick="getRandomAyah()">
                    <i class="fas fa-random"></i> Ø¢ÙŠØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
                </button>
            </div>
            
            <div class="search-section">
                <select id="reciterSelect" class="reciter-select">
                    <option value="ar.alafasy">Ù…Ø´Ø§Ø±ÙŠ Ø§Ù„Ø¹ÙØ§Ø³ÙŠ</option>
                    <option value="ar.abdurrahmaansudais">Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø³Ø¯ÙŠØ³</option>
                    <option value="ar.saoodshuraym">Ø³Ø¹ÙˆØ¯ Ø§Ù„Ø´Ø±ÙŠÙ…</option>
                    <option value="ar.mahermuaiqly">Ù…Ø§Ù‡Ø± Ø§Ù„Ù…Ø¹ÙŠÙ‚Ù„ÙŠ</option>
                    <option value="ar.abdullahbasfar">Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø¨ØµÙØ±</option>
                </select>
                <button class="btn btn-secondary" onclick="showAllSurahs()">
                    <i class="fas fa-list"></i> Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³ÙˆØ±
                </button>
            </div>
        </div>

        <div id="surahList" class="surah-grid">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ±...
            </div>
        </div>

        <div id="surahContent" class="surah-content">
            <!-- Surah content will be loaded here -->
        </div>
    </div>

    <div id="floatingAudio" class="floating-audio">
        <div class="audio-info">
            <div id="audioTitle" class="audio-title"></div>
            <div id="audioSubtitle" class="audio-subtitle"></div>
        </div>
        <div class="audio-controls">
            <button onclick="toggleAudio()" title="ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù">
                <i id="audioPlayIcon" class="fas fa-play"></i>
            </button>
            <button onclick="toggleAutoPlay()" id="autoPlayBtn" title="Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¢ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ©">
                <i id="autoPlayIcon" class="fas fa-forward"></i>
            </button>
            <button onclick="stopAudio()" title="Ø¥ÙŠÙ‚Ø§Ù">
                <i class="fas fa-stop"></i>
            </button>
            <button onclick="closeFloatingAudio()" title="Ø¥ØºÙ„Ø§Ù‚">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <audio id="audioPlayer" preload="none"></audio>
{% endblock %}

{% block scripts %}
    <script>
        let surahs = [];
        let currentAudio = null;
        let currentAyah = null;
        let autoPlayEnabled = true; // Auto-play is enabled by default

        // Load all surahs on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”¥ Enhanced Quran with Audio-Ayah Synchronization Loaded!');
            console.log('âœ… Auto-play enabled:', autoPlayEnabled);
            console.log('ğŸµ Audio synchronization features active!');
            
            loadSurahs();
            
            // Initialize auto-play button state
            const autoPlayBtn = document.getElementById('autoPlayBtn');
            if (autoPlayBtn && autoPlayEnabled) {
                autoPlayBtn.classList.add('auto-play-active');
                console.log('âœ… Auto-play button initialized');
            }
            
            // Add search functionality
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchSurahs();
                }
            });
        });

        async function loadSurahs() {
            try {
                const response = await fetch('/api/quran/surahs');
                const data = await response.json();
                
                if (data.success) {
                    surahs = data.data;
                    displaySurahs(surahs);
                } else {
                    showError('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ±: ' + data.error);
                }
            } catch (error) {
                showError('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ±: ' + error.message);
            }
        }

        function displaySurahs(surahList) {
            const container = document.getElementById('surahList');
            
            if (!surahList || surahList.length === 0) {
                container.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-exclamation-triangle"></i> Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³ÙˆØ±
                    </div>
                `;
                return;
            }
            
            container.innerHTML = surahList.map(surah => `
                <div class="surah-card" onclick="loadSurah(${surah.number})">
                    <div class="surah-number">${surah.number}</div>
                    <div class="surah-info">
                        <h3 class="surah-name">${surah.name}</h3>
                        <p class="surah-english">${surah.english_name}</p>
                        <div class="surah-meta">
                            <span class="ayah-count">${surah.ayahs || surah.number_of_ayahs || 'Ø¹Ø¯Ø¯ ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} Ø¢ÙŠØ©</span>
                            <i class="fas fa-play-circle audio-icon" onclick="event.stopPropagation(); playAudio(${surah.number}, '${surah.name}')" title="Ø§Ø³ØªÙ…Ø¹ Ù„Ù„Ø³ÙˆØ±Ø©"></i>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function searchSurahs() {
            const query = document.getElementById('searchInput').value.trim();
            
            if (!query) {
                displaySurahs(surahs);
                return;
            }
            
            try {
                const response = await fetch(`/api/quran/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.success) {
                    displaySurahs(data.data);
                } else {
                    // Fallback to client-side search
                    const filtered = surahs.filter(surah => 
                        surah.name.includes(query) || 
                        surah.english_name.toLowerCase().includes(query.toLowerCase()) ||
                        surah.number.toString() === query
                    );
                    displaySurahs(filtered);
                }
            } catch (error) {
                // Fallback to client-side search
                const filtered = surahs.filter(surah => 
                    surah.name.includes(query) || 
                    surah.english_name.toLowerCase().includes(query.toLowerCase()) ||
                    surah.number.toString() === query
                );
                displaySurahs(filtered);
            }
        }

        async function loadSurah(surahNumber) {
            const container = document.getElementById('surahContent');
            container.style.display = 'block';
            container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ±Ø©...</div>';
            
            // Scroll to content
            container.scrollIntoView({ behavior: 'smooth' });
            
            try {
                const response = await fetch(`/api/quran/surah/${surahNumber}`);
                const data = await response.json();
                
                if (data.success) {
                    const surah = data.data;
                    displaySurahContent(surah);
                } else {
                    showError('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ±Ø©: ' + data.error);
                }
            } catch (error) {
                showError('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ±Ø©: ' + error.message);
            }
        }

        function displaySurahContent(surah) {
            const container = document.getElementById('surahContent');
            
            let ayahsHtml = '';
            if (surah.ayahs && Array.isArray(surah.ayahs)) {
                ayahsHtml = surah.ayahs.map((ayah, index) => `
                    <div class="ayah-container" data-ayah="${ayah.number || index + 1}" data-surah="${surah.number}">
                        <div class="ayah-text">${ayah.text}</div>
                        <div class="ayah-info">
                            <span class="ayah-number">ï´¿${ayah.number || index + 1}ï´¾</span>
                            <button class="btn-icon ayah-play-btn" data-ayah="${ayah.number || index + 1}" onclick="playIndividualAyah(${surah.number}, ${ayah.number || index + 1}, '${ayah.audio || ''}')" title="Ø§Ø³ØªÙ…Ø¹ Ù„Ù„Ø¢ÙŠØ©">
                                <i class="fas fa-play-circle"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            } else {
                ayahsHtml = '<div class="loading">Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³ÙˆØ±Ø© ØºÙŠØ± Ù…ØªÙˆÙØ± Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
            }
            
            container.innerHTML = `
                <div class="surah-header">
                    <h2 class="surah-title">${surah.name}</h2>
                    <h3>${surah.english_name || surah.english_name_translation}</h3>
                    <div class="surah-info">
                        <span>Ø¹Ø¯Ø¯ Ø§Ù„Ø¢ÙŠØ§Øª: ${surah.number_of_ayahs}</span>
                        <span>Ø§Ù„Ù†ÙˆØ¹: ${surah.type || 'Ù…ÙƒÙŠØ©/Ù…Ø¯Ù†ÙŠØ©'}</span>
                    </div>
                    <div class="surah-controls">
                        <button onclick="playAudio(${surah.number}, '${surah.name}')" class="btn">
                            <i class="fas fa-play"></i> Ø§Ø³ØªÙ…Ø¹ Ù„Ù„Ø³ÙˆØ±Ø©
                        </button>
                        <button onclick="showAllSurahs()" class="btn btn-secondary">
                            <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø³ÙˆØ±
                        </button>
                    </div>
                </div>
                ${surah.number !== 9 ? `<div class="bismillah-verse">Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù</div>` : ''}
                <div class="ayahs-container">
                    ${ayahsHtml}
                </div>
            `;
        }

        async function getRandomAyah() {
            try {
                const response = await fetch('/api/quran/random');
                const data = await response.json();
                
                if (data.success) {
                    const randomData = data.data;
                    // Load the surah containing the random ayah
                    await loadSurah(randomData.surah.number);
                    
                    // Highlight the random ayah
                    setTimeout(() => {
                        const ayahElement = document.querySelector(`[data-ayah="${randomData.ayah.number}"]`);
                        if (ayahElement) {
                            ayahElement.style.background = 'rgba(255,215,0,0.2)';
                            ayahElement.style.borderColor = '#ffd700';
                            ayahElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 1000);
                } else {
                    showError('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¢ÙŠØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©: ' + data.error);
                }
            } catch (error) {
                showError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¢ÙŠØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©: ' + error.message);
            }
        }

        async function playAudio(surahNumber, surahName) {
            const reciter = document.getElementById('reciterSelect').value;
            
            try {
                const response = await fetch(`/api/quran/audio/${surahNumber}`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.audio_sources) {
                    // Use the audio sources from the backend
                    const audioSources = data.data.audio_sources;
                    let audioUrl = '';
                    
                    // Try to get the audio URL for the selected reciter
                    if (reciter === 'ar.alafasy' && audioSources.alafasy) {
                        audioUrl = audioSources.alafasy;
                    } else if (reciter === 'ar.abdurrahmaansudais' && audioSources.sudais) {
                        audioUrl = audioSources.sudais;
                    } else if (reciter === 'ar.mahermuaiqly' && audioSources.maher) {
                        audioUrl = audioSources.maher;
                    } else if (reciter === 'ar.saoodshuraym' && audioSources.sudais) {
                        audioUrl = audioSources.sudais;
                    } else {
                        // Default fallback to first available audio source
                        audioUrl = audioSources.alafasy || audioSources.sudais || audioSources.maher || Object.values(audioSources)[0];
                    }
                    
                    if (audioUrl) {
                        if (currentAudio) {
                            currentAudio.pause();
                        }
                        
                        currentAudio = new Audio(audioUrl);
                        
                        // Show floating audio player
                        document.getElementById('audioTitle').textContent = surahName;
                        document.getElementById('audioSubtitle').textContent = `Ø§Ù„Ù‚Ø§Ø±Ø¦: ${getReciterName(reciter)}`;
                        document.getElementById('floatingAudio').classList.add('show');
                        
                        currentAudio.play().catch(error => {
                            console.error('Audio playback failed:', error);
                            showError('ÙØ´Ù„ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª');
                        });
                        
                        updatePlayIcon();
                        
                        currentAudio.addEventListener('ended', () => {
                            document.getElementById('floatingAudio').classList.remove('show');
                        });
                    } else {
                        showError('Ù…ØµØ¯Ø± Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…ØªÙˆÙØ±');
                    }
                } else {
                    showError('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØª: ' + (data.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                }
            } catch (error) {
                showError('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØª: ' + error.message);
            }
        }

        function playIndividualAyah(surahNumber, ayahNumber, audioUrl) {
            // Remove highlighting from any previously playing ayah
            clearAyahHighlighting();
            
            // Add highlighting to current ayah
            const currentAyahElement = document.querySelector(`[data-ayah="${ayahNumber}"]`);
            const currentPlayButton = currentAyahElement ? currentAyahElement.querySelector('.ayah-play-btn') : null;
            
            if (currentAyahElement) {
                currentAyahElement.classList.add('playing');
                currentAyahElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                currentAyah = { element: currentAyahElement, number: ayahNumber, surah: surahNumber };
            }
            
            if (currentPlayButton) {
                currentPlayButton.classList.add('playing');
                currentPlayButton.innerHTML = '<i class="fas fa-pause-circle"></i>';
            }
            
            // Use the audio URL from Al-Quran Cloud API if available
            if (audioUrl && audioUrl !== '') {
                if (currentAudio) {
                    currentAudio.pause();
                }
                
                currentAudio = new Audio(audioUrl);
                
                // Show floating audio player
                document.getElementById('audioTitle').textContent = `Ø³ÙˆØ±Ø© ${surahNumber}`;
                document.getElementById('audioSubtitle').textContent = `Ø¢ÙŠØ© ${ayahNumber} - ${getReciterName('ar.alafasy')}`;
                document.getElementById('floatingAudio').classList.add('show');
                
                currentAudio.play().catch(error => {
                    console.error('Audio playback failed:', error);
                    // Fallback to alternative ayah audio function
                    playAyahAudio(surahNumber, ayahNumber);
                });
                
                updatePlayIcon();
                
                // Add event listeners for highlighting management
                currentAudio.addEventListener('ended', () => {
                    clearAyahHighlighting();
                    document.getElementById('floatingAudio').classList.remove('show');
                    // Auto-play next ayah if available
                    playNextAyah(surahNumber, ayahNumber);
                });
                
                currentAudio.addEventListener('pause', () => {
                    if (currentAyahElement) {
                        currentAyahElement.classList.remove('playing');
                    }
                    if (currentPlayButton) {
                        currentPlayButton.classList.remove('playing');
                        currentPlayButton.innerHTML = '<i class="fas fa-play-circle"></i>';
                    }
                });
                
                currentAudio.addEventListener('play', () => {
                    if (currentAyahElement) {
                        currentAyahElement.classList.add('playing');
                    }
                    if (currentPlayButton) {
                        currentPlayButton.classList.add('playing');
                        currentPlayButton.innerHTML = '<i class="fas fa-pause-circle"></i>';
                    }
                });
            } else {
                // Fallback to alternative ayah audio function
                playAyahAudio(surahNumber, ayahNumber);
            }
        }

        function playAyahAudio(surahNumber, ayahNumber) {
            // Remove highlighting from any previously playing ayah
            clearAyahHighlighting();
            
            // Add highlighting to current ayah
            const currentAyahElement = document.querySelector(`[data-ayah="${ayahNumber}"]`);
            if (currentAyahElement) {
                currentAyahElement.classList.add('playing');
                currentAyahElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                currentAyah = { element: currentAyahElement, number: ayahNumber, surah: surahNumber };
            }
            
            // Format numbers with leading zeros for individual ayah audio
            const formattedSurah = surahNumber.toString().padStart(3, '0');
            const formattedAyah = ayahNumber.toString().padStart(3, '0');
            
            const reciter = document.getElementById('reciterSelect').value;
            let reciterPath = '';
            
            switch(reciter) {
                case 'ar.alafasy':
                    reciterPath = 'Mishary_Rashid_Alafasy_128kbps';
                    break;
                case 'ar.abdurrahmaansudais':
                    reciterPath = 'Abdul_Muhsin_Al-Qasim_128kbps';
                    break;
                case 'ar.mahermuaiqly':
                    reciterPath = 'Maher_AlMuaiqly_128kbps';
                    break;
                case 'ar.saoodshuraym':
                    reciterPath = 'Husary_128kbps';
                    break;
                default:
                    reciterPath = 'Mishary_Rashid_Alafasy_128kbps';
            }
            
            const audioUrl = `https://www.everyayah.com/data/${reciterPath}/${formattedSurah}${formattedAyah}.mp3`;
            
            if (currentAudio) {
                currentAudio.pause();
            }
            
            currentAudio = new Audio(audioUrl);
            
            // Show floating audio player
            document.getElementById('audioTitle').textContent = `Ø³ÙˆØ±Ø© ${surahNumber}`;
            document.getElementById('audioSubtitle').textContent = `Ø¢ÙŠØ© ${ayahNumber} - ${getReciterName(reciter)}`;
            document.getElementById('floatingAudio').classList.add('show');
            
            currentAudio.play().catch(error => {
                console.error('Audio playback failed:', error);
                showError('ÙØ´Ù„ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª');
            });
            
            updatePlayIcon();
            
            // Add event listeners for highlighting management
            currentAudio.addEventListener('ended', () => {
                clearAyahHighlighting();
                document.getElementById('floatingAudio').classList.remove('show');
                // Auto-play next ayah if available
                playNextAyah(surahNumber, ayahNumber);
            });
            
            currentAudio.addEventListener('pause', () => {
                if (currentAyahElement) {
                    currentAyahElement.classList.remove('playing');
                }
            });
            
            currentAudio.addEventListener('play', () => {
                if (currentAyahElement) {
                    currentAyahElement.classList.add('playing');
                }
            });
        }

        function clearAyahHighlighting() {
            // Remove highlighting from all ayahs
            const playingAyahs = document.querySelectorAll('.ayah-container.playing');
            playingAyahs.forEach(ayah => {
                ayah.classList.remove('playing');
            });
            
            // Reset all play button states
            const playingButtons = document.querySelectorAll('.ayah-play-btn.playing');
            playingButtons.forEach(button => {
                button.classList.remove('playing');
                button.innerHTML = '<i class="fas fa-play-circle"></i>';
            });
            
            currentAyah = null;
        }

        function playNextAyah(currentSurahNumber, currentAyahNumber) {
            // Only auto-play if the feature is enabled
            if (!autoPlayEnabled) {
                return;
            }
            
            // Find the next ayah in the current surah
            const nextAyahElement = document.querySelector(`[data-ayah="${currentAyahNumber + 1}"]`);
            if (nextAyahElement) {
                // Add a small delay before playing the next ayah
                setTimeout(() => {
                    // Get the next ayah's audio URL if available
                    const playButton = nextAyahElement.querySelector('.btn-icon');
                    if (playButton) {
                        playButton.click();
                    }
                }, 1000); // 1 second delay between ayahs
            }
        }

        function toggleAutoPlay() {
            autoPlayEnabled = !autoPlayEnabled;
            const autoPlayBtn = document.getElementById('autoPlayBtn');
            const autoPlayIcon = document.getElementById('autoPlayIcon');
            
            if (autoPlayEnabled) {
                autoPlayBtn.classList.add('auto-play-active');
                autoPlayIcon.className = 'fas fa-forward';
                autoPlayBtn.title = 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¢ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ©';
            } else {
                autoPlayBtn.classList.remove('auto-play-active');
                autoPlayIcon.className = 'fas fa-step-forward';
                autoPlayBtn.title = 'ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¢ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ©';
            }
        }

        function getReciterName(reciterCode) {
            const reciters = {
                'ar.alafasy': 'Ù…Ø´Ø§Ø±ÙŠ Ø§Ù„Ø¹ÙØ§Ø³ÙŠ',
                'ar.abdurrahmaansudais': 'Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø³Ø¯ÙŠØ³',
                'ar.saoodshuraym': 'Ø³Ø¹ÙˆØ¯ Ø§Ù„Ø´Ø±ÙŠÙ…',
                'ar.mahermuaiqly': 'Ù…Ø§Ù‡Ø± Ø§Ù„Ù…Ø¹ÙŠÙ‚Ù„ÙŠ',
                'ar.abdullahbasfar': 'Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø¨ØµÙØ±'
            };
            return reciters[reciterCode] || reciterCode;
        }

        function toggleAudio() {
            if (currentAudio) {
                if (currentAudio.paused) {
                    currentAudio.play();
                } else {
                    currentAudio.pause();
                }
                updatePlayIcon();
            }
        }

        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                document.getElementById('floatingAudio').classList.remove('show');
            }
            clearAyahHighlighting();
        }

        function closeFloatingAudio() {
            if (currentAudio) {
                currentAudio.pause();
            }
            document.getElementById('floatingAudio').classList.remove('show');
            clearAyahHighlighting();
        }

        function updatePlayIcon() {
            const icon = document.getElementById('audioPlayIcon');
            if (currentAudio && !currentAudio.paused) {
                icon.className = 'fas fa-pause';
            } else {
                icon.className = 'fas fa-play';
            }
        }

        function showAllSurahs() {
            document.getElementById('surahContent').style.display = 'none';
            document.getElementById('searchInput').value = '';
            displaySurahs(surahs);
        }

        function showError(message) {
            const container = document.getElementById('surahList');
            container.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i> ${message}
                </div>
            `;
        }

        // Handle audio events
        document.addEventListener('DOMContentLoaded', function() {
            if (currentAudio) {
                currentAudio.addEventListener('pause', updatePlayIcon);
                currentAudio.addEventListener('play', updatePlayIcon);
            }
            
            // Initialize user data sync for Quran
            initializeQuranUserData();
        });

        // User Data Sync Functions for Quran
        function initializeQuranUserData() {
            // Load user bookmarks and reading progress
            loadUserBookmarks();
            
            // Add bookmark buttons to ayahs
            addBookmarkButtons();
            
            // Track reading progress
            trackReadingProgress();
            
            // Listen for user preferences changes
            window.addEventListener('userPreferencesLoaded', function(event) {
                applyQuranPreferences(event.detail);
            });
        }

        async function loadUserBookmarks() {
            if (!window.userDataSync) return;
            
            try {
                const bookmarks = await window.userDataSync.getQuranBookmarks();
                displayBookmarks(bookmarks);
            } catch (error) {
                console.error('Error loading bookmarks:', error);
            }
        }

        function addBookmarkButtons() {
            // Add this to the ayah rendering function
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes.length > 0) {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === 1 && node.classList && node.classList.contains('ayah')) {
                                addBookmarkButtonToAyah(node);
                            }
                        });
                    }
                });
            });
            
            observer.observe(document.getElementById('surahContent'), {
                childList: true,
                subtree: true
            });
        }

        function addBookmarkButtonToAyah(ayahElement) {
            const surahNumber = getCurrentSurahNumber();
            const ayahNumber = ayahElement.dataset.ayah;
            
            if (!surahNumber || !ayahNumber) return;
            
            const bookmarkBtn = document.createElement('button');
            bookmarkBtn.className = 'bookmark-btn';
            bookmarkBtn.title = 'Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø©';
            bookmarkBtn.innerHTML = '<i class="far fa-bookmark"></i>';
            bookmarkBtn.onclick = () => toggleBookmark(surahNumber, ayahNumber, bookmarkBtn);
            
            // Check if already bookmarked
            checkBookmarkStatus(surahNumber, ayahNumber, bookmarkBtn);
            
            // Add to ayah controls
            const ayahControls = ayahElement.querySelector('.ayah-controls') || createAyahControls(ayahElement);
            ayahControls.appendChild(bookmarkBtn);
        }

        function createAyahControls(ayahElement) {
            const controls = document.createElement('div');
            controls.className = 'ayah-controls';
            ayahElement.appendChild(controls);
            return controls;
        }

        async function checkBookmarkStatus(surahNumber, ayahNumber, button) {
            if (!window.userDataSync) return;
            
            try {
                const bookmarks = await window.userDataSync.getQuranBookmarks();
                const isBookmarked = bookmarks.some(b => 
                    b.surah_number == surahNumber && b.ayah_number == ayahNumber
                );
                
                if (isBookmarked) {
                    button.classList.add('bookmarked');
                    button.innerHTML = '<i class="fas fa-bookmark"></i>';
                    button.title = 'Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©';
                }
            } catch (error) {
                console.error('Error checking bookmark status:', error);
            }
        }

        async function toggleBookmark(surahNumber, ayahNumber, button) {
            if (!window.userDataSync) {
                alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø­ÙØ¸ Ø§Ù„Ù…ÙØ¶Ù„Ø©');
                return;
            }
            
            const isBookmarked = button.classList.contains('bookmarked');
            
            try {
                if (isBookmarked) {
                    const success = await window.userDataSync.removeQuranBookmark(surahNumber, ayahNumber);
                    if (success) {
                        button.classList.remove('bookmarked');
                        button.innerHTML = '<i class="far fa-bookmark"></i>';
                        button.title = 'Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø©';
                        showMessage('ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¢ÙŠØ© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©', 'success');
                    }
                } else {
                    const bookmark = {
                        surah_number: surahNumber,
                        ayah_number: ayahNumber,
                        note: `Ø³ÙˆØ±Ø© ${getCurrentSurahName()} - Ø¢ÙŠØ© ${ayahNumber}`
                    };
                    
                    const success = await window.userDataSync.addQuranBookmark(bookmark);
                    if (success) {
                        button.classList.add('bookmarked');
                        button.innerHTML = '<i class="fas fa-bookmark"></i>';
                        button.title = 'Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©';
                        showMessage('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¢ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø©', 'success');
                        
                        // Track first bookmark achievement
                        await window.userDataSync.trackFirstBookmark();
                    }
                }
            } catch (error) {
                console.error('Error toggling bookmark:', error);
                showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…ÙØ¶Ù„Ø©', 'error');
            }
        }

        function trackReadingProgress() {
            // Track when user reads an ayah (scrolls to it or plays audio)
            const ayahElements = document.querySelectorAll('.ayah');
            
            const observer = new IntersectionObserver(function(entries) {
                entries.forEach(function(entry) {
                    if (entry.isIntersecting && entry.intersectionRatio > 0.5) {
                        const ayahElement = entry.target;
                        const surahNumber = getCurrentSurahNumber();
                        const ayahNumber = ayahElement.dataset.ayah;
                        
                        if (surahNumber && ayahNumber) {
                            updateReadingProgress(surahNumber, ayahNumber);
                        }
                    }
                });
            }, { threshold: 0.5 });
            
            ayahElements.forEach(function(ayah) {
                observer.observe(ayah);
            });
        }

        async function updateReadingProgress(surahNumber, ayahNumber) {
            if (!window.userDataSync) return;
            
            try {
                // Update reading streak (simplified logic)
                const today = new Date().toDateString();
                const lastReadDate = localStorage.getItem('lastQuranReadDate');
                let streak = parseInt(localStorage.getItem('quranReadingStreak') || '0');
                
                if (lastReadDate !== today) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    if (lastReadDate === yesterday.toDateString()) {
                        streak += 1;
                    } else if (lastReadDate !== today) {
                        streak = 1;
                    }
                    
                    localStorage.setItem('lastQuranReadDate', today);
                    localStorage.setItem('quranReadingStreak', streak.toString());
                }
                
                await window.userDataSync.updateQuranProgress(surahNumber, ayahNumber, streak);
                await window.userDataSync.updateReadingStats({ quran_verses_read: 1 });
                
                // Use the new achievement tracking method
                await window.userDataSync.trackQuranReading(1);
                
                // Check for achievements
                checkReadingAchievements(streak);
                
            } catch (error) {
                console.error('Error updating reading progress:', error);
            }
        }

        async function checkReadingAchievements(streak) {
            if (!window.userDataSync) return;
            
            // Check for streak achievements
            if (streak === 7) {
                await window.userDataSync.addAchievement('reading_streak', 'Ø£Ø³Ø¨ÙˆØ¹ Ù…Ù† Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø©! ğŸ“–', { streak: 7 });
            } else if (streak === 30) {
                await window.userDataSync.addAchievement('reading_streak', 'Ø´Ù‡Ø± Ù…Ù† Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø©! ğŸ†', { streak: 30 });
            } else if (streak === 100) {
                await window.userDataSync.addAchievement('reading_streak', 'Ù…Ø§Ø¦Ø© ÙŠÙˆÙ… Ù…Ù† Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©! ğŸ‰', { streak: 100 });
            }
        }

        function applyQuranPreferences(preferences) {
            // Apply reciter preference
            if (preferences.favorite_reciter) {
                const reciterSelect = document.getElementById('reciterSelect');
                if (reciterSelect) {
                    reciterSelect.value = preferences.favorite_reciter;
                }
            }
            
            // Apply other Quran-specific preferences
            if (preferences.language_preference) {
                // Update display language if needed
                updateDisplayLanguage(preferences.language_preference);
            }
        }

        function displayBookmarks(bookmarks) {
            // Add a bookmarks section to the UI
            if (bookmarks.length === 0) return;
            
            const bookmarksSection = document.createElement('div');
            bookmarksSection.className = 'bookmarks-section';
            bookmarksSection.innerHTML = `
                <h3>Ø§Ù„Ù…ÙØ¶Ù„Ø© (${bookmarks.length})</h3>
                <div class="bookmarks-list">
                    ${bookmarks.map(bookmark => `
                        <div class="bookmark-item" onclick="goToBookmark(${bookmark.surah_number}, ${bookmark.ayah_number})">
                            <span>Ø³ÙˆØ±Ø© ${getSurahNameById(bookmark.surah_number)} - Ø¢ÙŠØ© ${bookmark.ayah_number}</span>
                            <button onclick="event.stopPropagation(); removeBookmark(${bookmark.surah_number}, ${bookmark.ayah_number})" class="btn-remove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
            
            const controls = document.querySelector('.controls');
            controls.appendChild(bookmarksSection);
        }

        async function goToBookmark(surahNumber, ayahNumber) {
            // Load the surah and scroll to the specific ayah
            await loadSurah(surahNumber);
            
            setTimeout(() => {
                const ayahElement = document.querySelector(`[data-ayah="${ayahNumber}"]`);
                if (ayahElement) {
                    ayahElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    ayahElement.classList.add('highlighted');
                    
                    setTimeout(() => {
                        ayahElement.classList.remove('highlighted');
                    }, 3000);
                }
            }, 500);
        }

        async function removeBookmark(surahNumber, ayahNumber) {
            if (!window.userDataSync) return;
            
            try {
                const success = await window.userDataSync.removeQuranBookmark(surahNumber, ayahNumber);
                if (success) {
                    showMessage('ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¢ÙŠØ© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©', 'success');
                    // Refresh bookmarks display
                    await loadUserBookmarks();
                }
            } catch (error) {
                console.error('Error removing bookmark:', error);
                showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø©', 'error');
            }
        }

        function getCurrentSurahNumber() {
            // Extract current surah number from the URL or current state
            const surahContent = document.getElementById('surahContent');
            const surahElement = surahContent.querySelector('.surah');
            return surahElement ? surahElement.dataset.surahNumber : null;
        }

        function getCurrentSurahName() {
            const surahElement = document.querySelector('.surah');
            if (surahElement) {
                const titleElement = surahElement.querySelector('.surah-title');
                return titleElement ? titleElement.textContent : '';
            }
            return '';
        }

        function getSurahNameById(id) {
            const surah = surahs.find(s => s.number == id);
            return surah ? surah.name : `${id}`;
        }

        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${type === 'success' ? 'var(--success-color)' : type === 'error' ? 'var(--error-color)' : 'var(--info-color)'};
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 1001;
                animation: slideInRight 0.3s ease;
            `;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        function updateDisplayLanguage(language) {
            // Update UI elements based on language preference
            if (language === 'en') {
                // Switch to English labels if needed
                document.documentElement.lang = 'en';
                document.documentElement.dir = 'ltr';
            } else {
                document.documentElement.lang = 'ar';
                document.documentElement.dir = 'rtl';
            }
        }
    </script>
{% endblock %}
