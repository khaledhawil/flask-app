{% extends "base.html" %}

{% block title %}Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª - Settings{% endblock %}

{% block styles %}
<style>
    .settings-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 1rem;
    }

    .settings-header {
        text-align: center;
        margin-bottom: 3rem;
        background: var(--card-bg);
        padding: 2rem;
        border-radius: 20px;
        border: 2px solid var(--border-color);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .settings-title {
        font-size: 2.5rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
        font-weight: 700;
    }

    .settings-description {
        color: var(--text-secondary);
        font-size: 1.1rem;
        margin-bottom: 2rem;
    }

    .settings-sections {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 2rem;
        margin-bottom: 3rem;
    }

    .settings-section {
        background: var(--card-bg);
        border: 2px solid var(--border-color);
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .settings-section:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
        border-color: var(--primary-color);
    }

    .section-header {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border-color);
    }

    .section-icon {
        font-size: 2rem;
        margin-left: 1rem;
        color: var(--primary-color);
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }

    .section-description {
        color: var(--text-secondary);
        margin-bottom: 1.5rem;
        line-height: 1.6;
    }

    .setting-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid var(--border-color);
    }

    .setting-item:last-child {
        border-bottom: none;
    }

    .setting-label {
        font-weight: 500;
        color: var(--text-primary);
        flex: 1;
    }

    .setting-control {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 34px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background-color: var(--primary-color);
    }

    input:checked + .slider:before {
        transform: translateX(26px);
    }

    .volume-control {
        display: flex;
        align-items: center;
        gap: 1rem;
        min-width: 200px;
    }

    .volume-slider {
        flex: 1;
        height: 5px;
        border-radius: 5px;
        background: var(--border-color);
        outline: none;
        -webkit-appearance: none;
    }

    .volume-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--primary-color);
        cursor: pointer;
    }

    .volume-slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--primary-color);
        cursor: pointer;
        border: none;
    }

    .time-input {
        padding: 0.5rem;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        background: var(--input-bg);
        color: var(--text-primary);
        font-size: 1rem;
        text-align: center;
        width: 80px;
    }

    .time-input:focus {
        outline: none;
        border-color: var(--primary-color);
    }

    .test-buttons {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 1rem;
    }

    .test-btn {
        padding: 0.7rem 1.5rem;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        flex: 1;
        min-width: 120px;
    }

    .test-btn:hover {
        background: var(--primary-hover);
        transform: translateY(-2px);
    }

    .save-settings-btn {
        background: linear-gradient(135deg, var(--primary-color), #27ae60);
        color: white;
        border: none;
        padding: 1rem 3rem;
        border-radius: 15px;
        font-size: 1.2rem;
        font-weight: 600;
        cursor: pointer;
        margin: 2rem auto;
        display: block;
        transition: all 0.3s ease;
        min-width: 200px;
    }

    .save-settings-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    .notification-status {
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        text-align: center;
        font-weight: 500;
    }

    .status-granted {
        background: rgba(39, 174, 96, 0.1);
        border: 2px solid #27ae60;
        color: #27ae60;
    }

    .status-denied {
        background: rgba(231, 76, 60, 0.1);
        border: 2px solid #e74c3c;
        color: #e74c3c;
    }

    .status-default {
        background: rgba(243, 156, 18, 0.1);
        border: 2px solid #f39c12;
        color: #f39c12;
    }

    .advanced-settings {
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 2px solid var(--border-color);
    }

    .advanced-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 1rem;
    }

    .quick-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
        flex-wrap: wrap;
    }

    .quick-action-btn {
        padding: 0.8rem 1.5rem;
        border: 2px solid var(--primary-color);
        background: transparent;
        color: var(--primary-color);
        border-radius: 10px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
        flex: 1;
        min-width: 150px;
    }

    .quick-action-btn:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-2px);
    }

    @media (max-width: 768px) {
        .settings-sections {
            grid-template-columns: 1fr;
        }
        
        .setting-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .setting-control {
            width: 100%;
            justify-content: space-between;
        }
        
        .test-buttons, .quick-actions {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="settings-container">
    <div class="settings-header">
        <h1 class="settings-title">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h1>
        <p class="settings-description">
            ØªØ®ØµÙŠØµ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ Ø­Ø³Ø¨ ØªÙØ¶ÙŠÙ„Ø§ØªÙƒ
        </p>
    </div>

    <div class="settings-sections">
        <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª -->
        <div class="settings-section">
            <div class="section-header">
                <div class="section-icon">ğŸ”Š</div>
                <h2 class="section-title">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª</h2>
            </div>
            <p class="section-description">
                ØªØ­ÙƒÙ… ÙÙŠ Ø£ØµÙˆØ§Øª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙˆØ§Ù„Ø£Ø°Ø§Ù† ÙˆØ§Ù„Ø£Ø°ÙƒØ§Ø±
            </p>
            
            <div class="setting-item">
                <span class="setting-label">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª</span>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="audioEnabled" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="setting-item">
                <span class="setting-label">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª Ø§Ù„Ø¹Ø§Ù…</span>
                <div class="setting-control">
                    <div class="volume-control">
                        <span>ğŸ”‰</span>
                        <input type="range" id="masterVolume" class="volume-slider" min="0" max="100" value="70">
                        <span id="volumeValue">70%</span>
                    </div>
                </div>
            </div>

            <div class="setting-item">
                <span class="setting-label">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØµØ§Ù…Øª Ù…Ù†</span>
                <div class="setting-control">
                    <input type="time" id="silentStart" class="time-input" value="22:00">
                    <span>Ø¥Ù„Ù‰</span>
                    <input type="time" id="silentEnd" class="time-input" value="06:00">
                </div>
            </div>

            <div class="setting-item">
                <span class="setting-label">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø²</span>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="vibrationEnabled" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="test-buttons">
                <button class="test-btn" onclick="testPrayerSound()">Ø§Ø®ØªØ¨Ø§Ø± Ø£Ø°Ø§Ù†</button>
                <button class="test-btn" onclick="testAzkarSound()">Ø§Ø®ØªØ¨Ø§Ø± Ø£Ø°ÙƒØ§Ø±</button>
                <button class="test-btn" onclick="testNotificationSound()">Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø´Ø¹Ø§Ø±</button>
            </div>
        </div>

        <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª -->
        <div class="settings-section">
            <div class="section-header">
                <div class="section-icon">ğŸ””</div>
                <h2 class="section-title">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h2>
            </div>
            <p class="section-description">
                ØªØ®ØµÙŠØµ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© ÙˆØ§Ù„Ø£Ø°ÙƒØ§Ø± ÙˆØ§Ù„Ù‚Ø±Ø¢Ù†
            </p>

            <div id="notificationStatus" class="notification-status">
                Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª...
            </div>

            <div class="setting-item">
                <span class="setting-label">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ØµÙ„Ø§Ø© Ø§Ù„ÙØ¬Ø±</span>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="fajrNotifications" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="setting-item">
                <span class="setting-label">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¨Ø§Ù‚ÙŠ Ø§Ù„ØµÙ„ÙˆØ§Øª</span>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="regularPrayerNotifications" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="setting-item">
                <span class="setting-label">Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­</span>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="morningAzkarNotifications" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="setting-item">
                <span class="setting-label">Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù…Ø³Ø§Ø¡</span>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="eveningAzkarNotifications" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="setting-item">
                <span class="setting-label">Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù†ÙˆÙ…</span>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="sleepAzkarNotifications" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="setting-item">
                <span class="setting-label">ØªØ°ÙƒÙŠØ± Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙŠÙˆÙ…ÙŠ</span>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="quranNotifications" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="test-buttons">
                <button class="test-btn" onclick="testNotification()">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡</button>
                <button class="test-btn" onclick="requestNotificationPermission()">Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†</button>
            </div>
        </div>

        <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¸Ù‡Ø± -->
        <div class="settings-section">
            <div class="section-header">
                <div class="section-icon">ğŸ¨</div>
                <h2 class="section-title">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¸Ù‡Ø±</h2>
            </div>
            <p class="section-description">
                ØªØ®ØµÙŠØµ Ø£Ù„ÙˆØ§Ù† ÙˆÙ…Ø¸Ù‡Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            </p>

            <div class="setting-item">
                <span class="setting-label">Ø§Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</span>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="themeToggle">
                        <span class="slider"></span>
                    </label>
                    <span id="themeStatus">Ø§Ù„Ø¯Ø§ÙƒÙ†</span>
                </div>
            </div>

            <div class="setting-item">
                <span class="setting-label">Ø­Ø¬Ù… Ø§Ù„Ø®Ø·</span>
                <div class="setting-control">
                    <select id="fontSize" style="padding: 0.5rem; border-radius: 5px; border: 2px solid var(--border-color);">
                        <option value="small">ØµØºÙŠØ±</option>
                        <option value="medium" selected>Ù…ØªÙˆØ³Ø·</option>
                        <option value="large">ÙƒØ¨ÙŠØ±</option>
                    </select>
                </div>
            </div>

            <div class="test-buttons">
                <button class="test-btn" onclick="toggleTheme()">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¸Ù‡Ø±</button>
                <button class="test-btn" onclick="resetTheme()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            </div>
        </div>

        <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ø§Ù…Ø© -->
        <div class="settings-section">
            <div class="section-header">
                <div class="section-icon">âš™ï¸</div>
                <h2 class="section-title">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h2>
            </div>
            <p class="section-description">
                Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </p>

            <div class="setting-item">
                <span class="setting-label">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹</span>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="saveDataLocally" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="setting-item">
                <span class="setting-label">ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø©</span>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoUpdatePrayerTimes" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="setting-item">
                <span class="setting-label">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­ÙƒÙ… Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©</span>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="showWisdomQuotes" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="advanced-settings">
                <h3 class="advanced-title">ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</h3>
                
                <div class="quick-actions">
                    <button class="quick-action-btn" onclick="exportSettings()">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                    <button class="quick-action-btn" onclick="importSettings()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                    <button class="quick-action-btn" onclick="resetAllSettings()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒÙ„</button>
                    <button class="quick-action-btn" onclick="clearCache()">Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©</button>
                </div>
            </div>
        </div>

        <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ§Ù„ØªØ´Ø®ÙŠØµ -->
        <div class="settings-section">
            <div class="section-header">
                <div class="section-icon">ğŸ§ª</div>
                <h2 class="section-title">Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
            </div>
            <p class="section-description">
                Ø§Ø®ØªØ¨Ø§Ø± ÙˆØªØ´Ø®ÙŠØµ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            </p>

            <div class="test-buttons">
                <button class="test-btn" onclick="window.location.href='/sound_test'">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„Ø´Ø§Ù…Ù„</button>
                <button class="test-btn" onclick="window.location.href='/notification_test'">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</button>
                <button class="test-btn" onclick="testAllFeatures()">Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Øª</button>
                <button class="test-btn" onclick="generateSystemReport()">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</button>
            </div>

            <div class="advanced-settings">
                <h3 class="advanced-title">ğŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
                <div id="systemInfo" style="background: var(--input-bg); padding: 1rem; border-radius: 10px; font-family: monospace; font-size: 0.9rem; color: var(--text-secondary);">
                    Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…...
                </div>
            </div>
        </div>
    </div>

    <button class="save-settings-btn" onclick="saveAllSettings()">
        ğŸ’¾ Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    </button>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadAllSettings();
    checkNotificationStatus();
    updateSystemInfo();
    
    // Setup event listeners
    setupEventListeners();
});

function setupEventListeners() {
    // Volume slider
    const volumeSlider = document.getElementById('masterVolume');
    const volumeValue = document.getElementById('volumeValue');
    
    volumeSlider.addEventListener('input', function() {
        volumeValue.textContent = this.value + '%';
        if (window.audioManager) {
            window.audioManager.setMasterVolume(this.value / 100);
        }
    });

    // Theme toggle
    const themeToggle = document.getElementById('themeToggle');
    const themeStatus = document.getElementById('themeStatus');
    
    themeToggle.addEventListener('change', function() {
        toggleTheme();
        themeStatus.textContent = this.checked ? 'Ø§Ù„ÙØ§ØªØ­' : 'Ø§Ù„Ø¯Ø§ÙƒÙ†';
    });

    // Auto-save settings on change
    const settingInputs = document.querySelectorAll('input[type="checkbox"], input[type="range"], input[type="time"], select');
    settingInputs.forEach(input => {
        input.addEventListener('change', saveAllSettings);
    });
}

function loadAllSettings() {
    // Load audio settings
    const audioSettings = JSON.parse(localStorage.getItem('audioSettings')) || {};
    document.getElementById('audioEnabled').checked = audioSettings.enabled !== false;
    document.getElementById('masterVolume').value = audioSettings.masterVolume || 70;
    document.getElementById('volumeValue').textContent = (audioSettings.masterVolume || 70) + '%';
    document.getElementById('silentStart').value = audioSettings.silentHours?.start || '22:00';
    document.getElementById('silentEnd').value = audioSettings.silentHours?.end || '06:00';
    document.getElementById('vibrationEnabled').checked = audioSettings.vibrationEnabled !== false;

    // Load notification settings
    const notificationSettings = JSON.parse(localStorage.getItem('islamicReminders')) || {};
    document.getElementById('fajrNotifications').checked = notificationSettings.fajr?.enabled !== false;
    document.getElementById('regularPrayerNotifications').checked = 
        (notificationSettings.dhuhr?.enabled !== false) && 
        (notificationSettings.asr?.enabled !== false) && 
        (notificationSettings.maghrib?.enabled !== false) && 
        (notificationSettings.isha?.enabled !== false);
    document.getElementById('morningAzkarNotifications').checked = notificationSettings.morning_azkar?.enabled !== false;
    document.getElementById('eveningAzkarNotifications').checked = notificationSettings.evening_azkar?.enabled !== false;
    document.getElementById('sleepAzkarNotifications').checked = notificationSettings.sleep_azkar?.enabled !== false;
    document.getElementById('quranNotifications').checked = notificationSettings.daily_quran?.enabled !== false;

    // Load theme settings
    const currentTheme = document.body.getAttribute('data-theme');
    document.getElementById('themeToggle').checked = currentTheme === 'light';
    document.getElementById('themeStatus').textContent = currentTheme === 'light' ? 'Ø§Ù„ÙØ§ØªØ­' : 'Ø§Ù„Ø¯Ø§ÙƒÙ†';

    // Load general settings
    document.getElementById('saveDataLocally').checked = localStorage.getItem('saveDataLocally') !== 'false';
    document.getElementById('autoUpdatePrayerTimes').checked = localStorage.getItem('autoUpdatePrayerTimes') !== 'false';
    document.getElementById('showWisdomQuotes').checked = localStorage.getItem('showWisdomQuotes') !== 'false';
}

function saveAllSettings() {
    // Save audio settings
    const audioSettings = {
        enabled: document.getElementById('audioEnabled').checked,
        masterVolume: parseInt(document.getElementById('masterVolume').value),
        silentHours: {
            start: document.getElementById('silentStart').value,
            end: document.getElementById('silentEnd').value
        },
        vibrationEnabled: document.getElementById('vibrationEnabled').checked
    };
    localStorage.setItem('audioSettings', JSON.stringify(audioSettings));

    // Update audio manager
    if (window.audioManager) {
        window.audioManager.updateSettings(audioSettings);
    }

    // Save notification settings
    const currentReminders = JSON.parse(localStorage.getItem('islamicReminders')) || {};
    
    // Update prayer notifications
    if (currentReminders.fajr) currentReminders.fajr.enabled = document.getElementById('fajrNotifications').checked;
    
    const regularPrayerEnabled = document.getElementById('regularPrayerNotifications').checked;
    ['dhuhr', 'asr', 'maghrib', 'isha'].forEach(prayer => {
        if (currentReminders[prayer]) currentReminders[prayer].enabled = regularPrayerEnabled;
    });

    // Update azkar notifications
    if (currentReminders.morning_azkar) currentReminders.morning_azkar.enabled = document.getElementById('morningAzkarNotifications').checked;
    if (currentReminders.evening_azkar) currentReminders.evening_azkar.enabled = document.getElementById('eveningAzkarNotifications').checked;
    if (currentReminders.sleep_azkar) currentReminders.sleep_azkar.enabled = document.getElementById('sleepAzkarNotifications').checked;
    if (currentReminders.daily_quran) currentReminders.daily_quran.enabled = document.getElementById('quranNotifications').checked;

    localStorage.setItem('islamicReminders', JSON.stringify(currentReminders));

    // Update notification service
    if (window.islamicNotifications) {
        window.islamicNotifications.reminders = currentReminders;
        window.islamicNotifications.scheduleAllReminders();
    }

    // Save general settings
    localStorage.setItem('saveDataLocally', document.getElementById('saveDataLocally').checked);
    localStorage.setItem('autoUpdatePrayerTimes', document.getElementById('autoUpdatePrayerTimes').checked);
    localStorage.setItem('showWisdomQuotes', document.getElementById('showWisdomQuotes').checked);

    // Show confirmation
    showSaveConfirmation();
}

function showSaveConfirmation() {
    const btn = document.querySelector('.save-settings-btn');
    const originalText = btn.textContent;
    btn.textContent = 'âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!';
    btn.style.background = '#27ae60';
    
    setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '';
    }, 2000);
}

function checkNotificationStatus() {
    const statusDiv = document.getElementById('notificationStatus');
    
    if (!('Notification' in window)) {
        statusDiv.className = 'notification-status status-denied';
        statusDiv.textContent = 'âŒ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª';
        return;
    }

    switch (Notification.permission) {
        case 'granted':
            statusDiv.className = 'notification-status status-granted';
            statusDiv.textContent = 'âœ… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…ÙØ¹Ù„Ø© ÙˆÙ…Ø³Ù…ÙˆØ­Ø©';
            break;
        case 'denied':
            statusDiv.className = 'notification-status status-denied';
            statusDiv.textContent = 'âŒ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…Ø­Ø¸ÙˆØ±Ø© - ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­';
            break;
        default:
            statusDiv.className = 'notification-status status-default';
            statusDiv.textContent = 'âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª';
    }
}

function updateSystemInfo() {
    const systemInfo = document.getElementById('systemInfo');
    const info = {
        'Ø§Ù„Ù…ØªØµÙØ­': navigator.userAgent.split(') ')[0].split('(')[1] || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
        'Ø§Ù„Ù„ØºØ©': navigator.language,
        'Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©': Intl.DateTimeFormat().resolvedOptions().timeZone,
        'Ø¯Ø¹Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª': 'Notification' in window ? 'Ù†Ø¹Ù…' : 'Ù„Ø§',
        'Ø¯Ø¹Ù… Ø§Ù„ØµÙˆØª': 'Audio' in window ? 'Ù†Ø¹Ù…' : 'Ù„Ø§',
        'Ø¯Ø¹Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹': 'geolocation' in navigator ? 'Ù†Ø¹Ù…' : 'Ù„Ø§',
        'Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„': navigator.onLine ? 'Ù…ØªØµÙ„' : 'ØºÙŠØ± Ù…ØªØµÙ„',
        'ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©': new Date().toLocaleString('ar-SA')
    };

    systemInfo.innerHTML = Object.entries(info)
        .map(([key, value]) => `${key}: ${value}`)
        .join('<br>');
}

// Test functions
function testPrayerSound() {
    if (window.audioManager) {
        window.audioManager.playPrayerSound('fajr');
    }
}

function testAzkarSound() {
    if (window.audioManager) {
        window.audioManager.playAzkarSound('morning');
    }
}

function testNotificationSound() {
    if (window.audioManager) {
        window.audioManager.playGeneralNotification();
    }
}

function testNotification() {
    if (window.islamicNotifications) {
        window.islamicNotifications.testNotification();
    }
}

async function requestNotificationPermission() {
    if ('Notification' in window) {
        const permission = await Notification.requestPermission();
        checkNotificationStatus();
        
        if (permission === 'granted') {
            testNotification();
        }
    }
}

function toggleTheme() {
    if (window.themeManager) {
        window.themeManager.toggleTheme();
    } else {
        // Fallback theme toggle
        const body = document.body;
        const currentTheme = body.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        body.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
    }
}

function resetTheme() {
    document.body.setAttribute('data-theme', 'dark');
    localStorage.setItem('theme', 'dark');
    document.getElementById('themeToggle').checked = false;
    document.getElementById('themeStatus').textContent = 'Ø§Ù„Ø¯Ø§ÙƒÙ†';
}

function exportSettings() {
    const settings = {
        audio: JSON.parse(localStorage.getItem('audioSettings') || '{}'),
        notifications: JSON.parse(localStorage.getItem('islamicReminders') || '{}'),
        theme: localStorage.getItem('theme') || 'dark',
        general: {
            saveDataLocally: localStorage.getItem('saveDataLocally'),
            autoUpdatePrayerTimes: localStorage.getItem('autoUpdatePrayerTimes'),
            showWisdomQuotes: localStorage.getItem('showWisdomQuotes')
        }
    };

    const dataStr = JSON.stringify(settings, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = 'islamic-app-settings.json';
    link.click();
    
    URL.revokeObjectURL(url);
}

function importSettings() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const settings = JSON.parse(e.target.result);
                    
                    // Import settings
                    if (settings.audio) localStorage.setItem('audioSettings', JSON.stringify(settings.audio));
                    if (settings.notifications) localStorage.setItem('islamicReminders', JSON.stringify(settings.notifications));
                    if (settings.theme) localStorage.setItem('theme', settings.theme);
                    if (settings.general) {
                        Object.entries(settings.general).forEach(([key, value]) => {
                            if (value !== null) localStorage.setItem(key, value);
                        });
                    }
                    
                    // Reload settings
                    loadAllSettings();
                    alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
                    
                } catch (error) {
                    alert('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
                }
            };
            reader.readAsText(file);
        }
    };
    
    input.click();
}

function resetAllSettings() {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªØŸ')) {
        // Clear all settings
        ['audioSettings', 'islamicReminders', 'theme', 'saveDataLocally', 'autoUpdatePrayerTimes', 'showWisdomQuotes'].forEach(key => {
            localStorage.removeItem(key);
        });
        
        // Reset to defaults
        document.body.setAttribute('data-theme', 'dark');
        loadAllSettings();
        
        alert('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
    }
}

function clearCache() {
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©ØŸ Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.')) {
        // Clear cache and reload
        if ('caches' in window) {
            caches.keys().then(names => {
                names.forEach(name => caches.delete(name));
            });
        }
        
        // Clear session storage
        sessionStorage.clear();
        
        // Reload page
        window.location.reload(true);
    }
}

function testAllFeatures() {
    const tests = [
        () => testNotification(),
        () => testPrayerSound(),
        () => testAzkarSound(),
        () => testNotificationSound()
    ];
    
    let testIndex = 0;
    const runNextTest = () => {
        if (testIndex < tests.length) {
            tests[testIndex]();
            testIndex++;
            setTimeout(runNextTest, 2000);
        } else {
            alert('ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Øª');
        }
    };
    
    runNextTest();
}

function generateSystemReport() {
    const report = {
        timestamp: new Date().toISOString(),
        browser: navigator.userAgent,
        settings: {
            audio: JSON.parse(localStorage.getItem('audioSettings') || '{}'),
            notifications: JSON.parse(localStorage.getItem('islamicReminders') || '{}')
        },
        permissions: {
            notifications: Notification.permission,
            geolocation: 'geolocation' in navigator
        },
        features: {
            audioSupport: 'Audio' in window,
            notificationSupport: 'Notification' in window,
            serviceWorkerSupport: 'serviceWorker' in navigator
        }
    };
    
    const reportStr = JSON.stringify(report, null, 2);
    const reportBlob = new Blob([reportStr], {type: 'application/json'});
    const url = URL.createObjectURL(reportBlob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = 'islamic-app-system-report.json';
    link.click();
    
    URL.revokeObjectURL(url);
}
</script>
{% endblock %}
