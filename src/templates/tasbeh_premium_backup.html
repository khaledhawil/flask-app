<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>التسبيح الإلكتروني المطور - Enhanced Digital Tasbeh</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700;900&family=Cairo:wght@300;400;600;700;900&family=Scheherazade+New:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 35%, #f093fb 100%);
            margin: 0;
            min-height: 100vh;
            direction: rtl;
            position: relative;
            overflow-x: hidden;
            color: #ffffff;
        }
        
        /* Animated Background Pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 25% 25%, rgba(255,255,255,0.05) 1px, transparent 1px),
                radial-gradient(circle at 75% 75%, rgba(255,255,255,0.05) 1px, transparent 1px),
                radial-gradient(circle at 50% 50%, rgba(255,215,0,0.03) 2px, transparent 2px);
            background-size: 50px 50px, 80px 80px, 30px 30px;
            animation: backgroundMove 20s linear infinite;
            z-index: -2;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 30% 70%, rgba(34, 197, 94, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 70% 30%, rgba(168, 85, 247, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(59, 130, 246, 0.08) 0%, transparent 50%);
            z-index: -1;
        }
        
        @keyframes backgroundMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }
        
        /* Enhanced Navbar */
        .navbar {
            background: linear-gradient(90deg, rgba(0,0,0,0.95), rgba(0,0,0,0.8));
            backdrop-filter: blur(20px);
            padding: 1rem 2rem;
            margin-bottom: 30px;
            direction: ltr;
            box-shadow: 0 8px 40px rgba(0,0,0,0.3);
            border-bottom: 2px solid rgba(255,215,0,0.2);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .navbar a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            padding: 12px 24px;
            border-radius: 30px;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.1);
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .navbar a:hover {
            background: rgba(255,215,0,0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255,215,0,0.3);
        }
        
        /* Container and Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Enhanced Header */
        .header {
            text-align: center;
            color: white;
            margin-bottom: 50px;
            animation: fadeInDown 1s ease-out;
        }
        
        .header h1 {
            font-family: 'Amiri', serif;
            font-size: 4em;
            margin-bottom: 15px;
            text-shadow: 3px 3px 12px rgba(0,0,0,0.6);
            background: linear-gradient(45deg, #fff, #ffd700, #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
        }
        
        .header h1::after {
            content: '✨';
            position: absolute;
            top: -10px;
            right: -30px;
            font-size: 0.4em;
            animation: sparkle 2s infinite;
        }
        
        @keyframes sparkle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }
        
        .header p {
            font-size: 1.3em;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        /* Statistics Dashboard */
        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
            animation: fadeInUp 1s ease-out 0.2s both;
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 30px;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.6s ease;
        }
        
        .stat-card:hover::before {
            left: 100%;
        }
        
        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
        }
        
        .stat-icon {
            font-size: 3em;
            margin-bottom: 15px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-title {
            font-family: 'Amiri', serif;
            font-size: 1.3em;
            margin-bottom: 10px;
            color: rgba(255,255,255,0.9);
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: 900;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: pulse 2s infinite;
        }
        
        /* Islamic Reminder Section */
        .islamic-reminder {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(16, 185, 129, 0.15));
            border-radius: 25px;
            padding: 30px;
            margin-bottom: 40px;
            text-align: center;
            border: 1px solid rgba(34, 197, 94, 0.3);
            animation: fadeInUp 1s ease-out 0.4s both;
            box-shadow: 0 8px 32px rgba(34, 197, 94, 0.2);
        }
        
        .islamic-reminder h4 {
            font-family: 'Amiri', serif;
            font-size: 1.8em;
            margin-bottom: 15px;
            color: #fff;
        }
        
        .islamic-reminder p {
            font-size: 1.1em;
            line-height: 1.8;
            margin: 10px 0;
            color: rgba(255,255,255,0.9);
        }
        
        /* Enhanced Phrase Container */
        .phrase-container {
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9));
            border-radius: 30px;
            padding: 40px;
            margin: 30px 0;
            box-shadow: 
                0 20px 60px rgba(0,0,0,0.15),
                0 8px 25px rgba(0,0,0,0.1);
            transition: all 0.5s ease;
            border: 2px solid rgba(255,255,255,0.3);
            animation: fadeInUp 0.8s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .phrase-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,215,0,0.2), transparent);
            transition: left 0.7s ease;
        }
        
        .phrase-container:hover::before {
            left: 100%;
        }
        
        .phrase-container:hover {
            transform: translateY(-12px) scale(1.02);
            box-shadow: 
                0 30px 80px rgba(0,0,0,0.2),
                0 15px 35px rgba(0,0,0,0.15);
        }
        
        .phrase-text {
            font-family: 'Amiri', serif;
            font-size: 2.8em;
            font-weight: 700;
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 20px;
            box-shadow: inset 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
            border: 2px solid rgba(255,215,0,0.2);
        }
        
        .phrase-text::before {
            content: '🤲';
            position: absolute;
            top: -10px;
            right: 15px;
            font-size: 0.6em;
            background: rgba(255,215,0,0.2);
            padding: 5px 10px;
            border-radius: 50%;
        }
        
        /* Enhanced Counter Section */
        .counter-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
        }
        
        .count-display {
            font-size: 4em;
            font-weight: 900;
            background: linear-gradient(45deg, #27ae60, #2ecc71, #58d68d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            min-width: 150px;
            text-align: center;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.1);
            position: relative;
            transition: all 0.3s ease;
        }
        
        .count-display::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 3px;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            border-radius: 2px;
        }
        
        /* Modern Button Styles */
        .count-btn {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: none;
            font-size: 2.2em;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .count-btn.main {
            background: linear-gradient(135deg, #2ecc71, #27ae60, #1abc9c);
            color: white;
            font-family: 'Cairo', sans-serif;
        }
        
        .count-btn.main::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transition: all 0.6s ease;
            transform: translate(-50%, -50%);
        }
        
        .count-btn.main:hover::before {
            width: 200px;
            height: 200px;
        }
        
        .count-btn.main:hover {
            transform: translateY(-8px) scale(1.1);
            box-shadow: 0 15px 40px rgba(46, 204, 113, 0.4);
        }
        
        .count-btn.main:active {
            transform: translateY(-4px) scale(1.05);
        }
        
        .reset-btn, .quick-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Cairo', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .reset-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        .reset-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }
        
        .quick-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .quick-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        }
        
        /* Quick Actions Panel */
        .quick-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }
        
        /* Progress Ring */
        .progress-ring {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
        }
        
        .progress-ring svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }
        
        .progress-ring circle {
            fill: transparent;
            stroke-width: 6;
            stroke-linecap: round;
        }
        
        .progress-ring .background {
            stroke: rgba(255,255,255,0.3);
        }
        
        .progress-ring .progress {
            stroke: #ffd700;
            stroke-dasharray: 251.2;
            stroke-dashoffset: 251.2;
            transition: stroke-dashoffset 0.5s ease;
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.9em;
            font-weight: 600;
            color: #ffd700;
        }
        
        /* Enhanced Hadith Quote */
        .hadith-quote {
            font-size: 1em;
            color: #7f8c8d;
            font-style: italic;
            margin-top: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            border-left: 4px solid #ffd700;
            text-align: center;
        }
        
        /* Last Updated */
        .last-updated {
            font-size: 0.9em;
            color: #95a5a6;
            text-align: center;
            margin-top: 15px;
            font-weight: 500;
        }
        
        /* Loading and Success Animations */
        .loading {
            opacity: 0.7;
            pointer-events: none;
            position: relative;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .success-animation {
            animation: successPulse 0.8s ease-out;
        }
        
        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(155, 89, 182, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
            direction: ltr;
        }
        
        .fab:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(155, 89, 182, 0.5);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.5em;
            }
            
            .phrase-text {
                font-size: 2.2em;
            }
            
            .count-btn {
                width: 100px;
                height: 100px;
                font-size: 1.8em;
            }
            
            .counter-section {
                gap: 25px;
            }
            
            .phrase-container {
                padding: 25px;
            }
            
            .stats-dashboard {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .counter-section {
                gap: 20px;
                flex-direction: column;
            }
            
            .count-display {
                font-size: 3em;
            }
            
            .phrase-text {
                font-size: 1.8em;
            }
            
            .fab {
                bottom: 20px;
                left: 20px;
            }
        }
        
        /* Animations */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { 
                transform: scale(1.15); 
                background: linear-gradient(135deg, #2ecc71, #27ae60, #58d68d);
            }
            100% { transform: scale(1); }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Dark Mode Toggle */
        .theme-toggle {
            position: fixed;
            top: 100px;
            left: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
            direction: ltr;
        }
        
        .theme-toggle:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(243, 156, 18, 0.4);
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="{{ url_for('home') }}"><i class="fas fa-home"></i> الصفحة الرئيسية</a>
        <a href="{{ url_for('my_phrases') }}"><i class="fas fa-heart"></i> عباراتي</a>
        <a href="{{ url_for('tasbeh') }}"><i class="fas fa-hands"></i> التسبيح</a>
        <a href="{{ url_for('prayer_times') }}"><i class="fas fa-clock"></i> أوقات الصلاة</a>
        <a href="{{ url_for('quran') }}"><i class="fas fa-book-quran"></i> القرآن</a>
        <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</a>
    </nav>

    <div class="container">
        <div class="header">
            <h1>🕌 التسبيح الإلكتروني المطور</h1>
            <p>Enhanced Digital Tasbeh for {{ username }}</p>
            <p style="font-size: 1em; opacity: 0.8;">اذكروا الله كثيراً لعلكم تفلحون</p>
        </div>

        <!-- Statistics Dashboard -->
        <div class="stats-dashboard">
            <div class="stat-card">
                <div class="stat-icon">📿</div>
                <div class="stat-title">إجمالي التسبيحات</div>
                <div class="stat-value" id="totalCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🎯</div>
                <div class="stat-title">الهدف اليومي</div>
                <div class="stat-value" id="dailyGoal">100</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🔥</div>
                <div class="stat-title">أيام متتالية</div>
                <div class="stat-value" id="streak">1</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">⭐</div>
                <div class="stat-title">النقاط المكتسبة</div>
                <div class="stat-value" id="points">0</div>
            </div>
        </div>

        <!-- Islamic Reminder -->
        <div class="islamic-reminder">
            <h4>🤲 فضل الذكر في الإسلام</h4>
            <p>"الَّذِينَ آمَنُوا وَتَطْمَئِنُّ قُلُوبُهُم بِذِكْرِ اللَّهِ ۗ أَلَا بِذِكْرِ اللَّهِ تَطْمَئِنُّ الْقُلُوبُ"</p>
            <p>"Those who believe and whose hearts are assured by the remembrance of Allah. Unquestionably, by the remembrance of Allah hearts are assured."</p>
            <p style="font-size: 0.9em; margin-top: 15px; color: rgba(255,255,255,0.8);">الرعد: 28</p>
        </div>

        <!-- Tasbeh Phrases -->
        {% for phrase_data in phrases %}
        <div class="phrase-container" style="animation-delay: {{ loop.index0 * 0.1 }}s">
            <!-- Progress Ring -->
            <div class="progress-ring">
                <svg>
                    <circle class="background" cx="40" cy="40" r="36"></circle>
                    <circle class="progress" cx="40" cy="40" r="36" id="progress-{{ loop.index0 }}"></circle>
                </svg>
                <div class="progress-text" id="progress-text-{{ loop.index0 }}">0%</div>
            </div>
            
            <div class="phrase-text">{{ phrase_data.phrase }}</div>
            
            <div class="counter-section">
                <button class="reset-btn" onclick="resetCount('{{ phrase_data.phrase }}', this, {{ loop.index0 }})">
                    <i class="fas fa-redo"></i> إعادة تعيين
                </button>
                
                <div class="count-display" id="count-{{ loop.index0 }}">
                    {{ phrase_data.count }}
                </div>
                
                <button class="count-btn main" onclick="incrementCount('{{ phrase_data.phrase }}', {{ loop.index0 }}, this)">
                    +1
                </button>
            </div>
            
            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="quick-btn" onclick="quickAdd('{{ phrase_data.phrase }}', {{ loop.index0 }}, 10)">
                    <i class="fas fa-plus"></i> +10
                </button>
                <button class="quick-btn" onclick="quickAdd('{{ phrase_data.phrase }}', {{ loop.index0 }}, 33)">
                    <i class="fas fa-plus"></i> +33
                </button>
                <button class="quick-btn" onclick="quickAdd('{{ phrase_data.phrase }}', {{ loop.index0 }}, 100)">
                    <i class="fas fa-plus"></i> +100
                </button>
            </div>
            
            {% if phrase_data.last_updated %}
            <div class="last-updated">
                <i class="fas fa-clock"></i> آخر تحديث: {{ phrase_data.last_updated }}
            </div>
            {% endif %}
            
            <div class="hadith-quote">
                {% if phrase_data.phrase == "سبحان الله" %}
                    <i class="fas fa-quote-right"></i> "من قال سبحان الله وبحمده في يوم مائة مرة حطت خطاياه" <i class="fas fa-quote-left"></i>
                {% elif phrase_data.phrase == "الحمد لله" %}
                    <i class="fas fa-quote-right"></i> "الحمد لله تملأ الميزان" <i class="fas fa-quote-left"></i>
                {% elif phrase_data.phrase == "الله أكبر" %}
                    <i class="fas fa-quote-right"></i> "التكبير يملأ ما بين السماء والأرض" <i class="fas fa-quote-left"></i>
                {% elif phrase_data.phrase == "لا إله إلا الله" %}
                    <i class="fas fa-quote-right"></i> "أفضل الذكر لا إله إلا الله" <i class="fas fa-quote-left"></i>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Floating Action Buttons -->
    <button class="fab" onclick="scrollToTop()" title="العودة للأعلى">
        <i class="fas fa-arrow-up"></i>
    </button>
    
    <button class="theme-toggle" onclick="toggleSound()" title="تشغيل/إيقاف الصوت" id="soundToggle">
        <i class="fas fa-volume-up"></i>
    </button>

    <script>
        // Global variables
        let soundEnabled = true;
        let dailyGoalTarget = 100;
        let totalCountToday = 0;
        
        // Initialize page
        window.onload = function() {
            updateTotalCount();
            updateDailyProgress();
            loadSettings();
            updateProgressRings();
        };

        // Enhanced increment function with animations and sound
        function incrementCount(phrase, index, button) {
            button.classList.add('loading');
            
            fetch('/tasbeh/count', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({phrase: phrase})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const countElement = document.getElementById('count-' + index);
                    countElement.textContent = data.count;
                    
                    // Update displays
                    updateTotalCount();
                    updateProgressRing(index, data.count);
                    updateDailyProgress();
                    
                    // Enhanced success animation
                    button.classList.add('success-animation');
                    countElement.style.transform = 'scale(1.3)';
                    countElement.style.color = '#27ae60';
                    
                    // Create floating number animation
                    createFloatingNumber(button, '+1');
                    
                    // Play success sound and haptic feedback
                    playSuccessSound();
                    triggerHapticFeedback();
                    
                    // Check for milestones
                    checkMilestones(data.count);
                    
                    setTimeout(() => {
                        button.classList.remove('success-animation');
                        countElement.style.transform = '';
                        countElement.style.color = '';
                    }, 800);
                } else {
                    showNotification('خطأ في التحديث', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('خطأ في الاتصال', 'error');
            })
            .finally(() => {
                button.classList.remove('loading');
            });
        }

        // Quick add function for bulk increments
        function quickAdd(phrase, index, amount) {
            const button = event.target;
            button.classList.add('loading');
            
            fetch('/tasbeh/quick-add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({phrase: phrase, amount: amount})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const countElement = document.getElementById('count-' + index);
                    countElement.textContent = data.count;
                    
                    updateTotalCount();
                    updateProgressRing(index, data.count);
                    updateDailyProgress();
                    
                    createFloatingNumber(button, '+' + amount);
                    playSuccessSound();
                    showNotification(`تم إضافة ${amount} تسبيحة!`, 'success');
                } else {
                    showNotification('خطأ في التحديث', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('خطأ في الاتصال', 'error');
            })
            .finally(() => {
                button.classList.remove('loading');
            });
        }

        // Enhanced reset function
        function resetCount(phrase, button, index) {
            if (!confirm('هل أنت متأكد من إعادة تعيين العداد؟\nسيتم فقدان جميع التسبيحات المحفوظة لهذه العبارة.')) {
                return;
            }
            
            button.classList.add('loading');
            
            fetch('/tasbeh/reset', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({phrase: phrase})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const countElement = document.getElementById('count-' + index);
                    countElement.textContent = '0';
                    
                    updateTotalCount();
                    updateProgressRing(index, 0);
                    updateDailyProgress();
                    
                    // Reset animation
                    countElement.style.transform = 'scale(0.8)';
                    countElement.style.color = '#e74c3c';
                    
                    setTimeout(() => {
                        countElement.style.transform = '';
                        countElement.style.color = '';
                    }, 400);
                    
                    showNotification('تم إعادة تعيين العداد', 'info');
                } else {
                    showNotification('خطأ في إعادة التعيين', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('خطأ في الاتصال', 'error');
            })
            .finally(() => {
                button.classList.remove('loading');
            });
        }

        // Update total count with enhanced animation
        function updateTotalCount() {
            fetch('/tasbeh/total')
            .then(response => response.json())
            .then(data => {
                const totalElement = document.getElementById('totalCount');
                const pointsElement = document.getElementById('points');
                
                // Animate number change
                animateNumber(totalElement, parseInt(totalElement.textContent), data.total);
                animateNumber(pointsElement, parseInt(pointsElement.textContent), data.total * 10);
                
                totalCountToday = data.total;
            })
            .catch(error => {
                console.error('Error updating total:', error);
            });
        }

        // Update progress rings
        function updateProgressRing(index, count) {
            const progressCircle = document.getElementById('progress-' + index);
            const progressText = document.getElementById('progress-text-' + index);
            const maxCount = 100; // Target for each phrase
            
            const percentage = Math.min((count / maxCount) * 100, 100);
            const offset = 251.2 - (251.2 * percentage) / 100;
            
            progressCircle.style.strokeDashoffset = offset;
            progressText.textContent = Math.round(percentage) + '%';
            
            // Change color based on progress
            if (percentage >= 100) {
                progressCircle.style.stroke = '#27ae60';
            } else if (percentage >= 75) {
                progressCircle.style.stroke = '#f39c12';
            } else {
                progressCircle.style.stroke = '#ffd700';
            }
        }

        // Initialize all progress rings
        function updateProgressRings() {
            document.querySelectorAll('[id^="count-"]').forEach((element, index) => {
                const count = parseInt(element.textContent);
                updateProgressRing(index, count);
            });
        }

        // Update daily progress
        function updateDailyProgress() {
            const dailyGoalElement = document.getElementById('dailyGoal');
            const streakElement = document.getElementById('streak');
            
            // Calculate streak (mock implementation)
            const streak = Math.floor(totalCountToday / 50) + 1;
            streakElement.textContent = streak;
        }

        // Animate number changes
        function animateNumber(element, start, end) {
            const duration = 800;
            const startTime = performance.now();
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                const current = Math.floor(start + (end - start) * progress);
                element.textContent = current;
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }
            
            requestAnimationFrame(update);
        }

        // Create floating number animation
        function createFloatingNumber(button, text) {
            const floating = document.createElement('div');
            floating.textContent = text;
            floating.style.position = 'absolute';
            floating.style.color = '#27ae60';
            floating.style.fontWeight = 'bold';
            floating.style.fontSize = '1.2em';
            floating.style.pointerEvents = 'none';
            floating.style.zIndex = '1000';
            
            const rect = button.getBoundingClientRect();
            floating.style.left = rect.left + rect.width / 2 + 'px';
            floating.style.top = rect.top + 'px';
            
            document.body.appendChild(floating);
            
            // Animate upward
            floating.animate([
                { transform: 'translateY(0) scale(1)', opacity: 1 },
                { transform: 'translateY(-50px) scale(1.2)', opacity: 0 }
            ], {
                duration: 1000,
                easing: 'ease-out'
            }).onfinish = () => {
                document.body.removeChild(floating);
            };
        }

        // Enhanced sound system
        function playSuccessSound() {
            if (!soundEnabled) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Create a pleasant chime sound
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                // Audio not supported
            }
        }

        // Haptic feedback for mobile devices
        function triggerHapticFeedback() {
            if ('vibrate' in navigator) {
                navigator.vibrate(50);
            }
        }

        // Check for milestones and achievements
        function checkMilestones(count) {
            const milestones = [10, 33, 50, 100, 500, 1000];
            
            milestones.forEach(milestone => {
                if (count === milestone) {
                    showMilestoneNotification(milestone);
                    playMilestoneSound();
                }
            });
        }

        // Show milestone notification
        function showMilestoneNotification(milestone) {
            showNotification(`🎉 مبروك! وصلت إلى ${milestone} تسبيحة!`, 'achievement');
        }

        // Play milestone sound
        function playMilestoneSound() {
            if (!soundEnabled) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Play a sequence of notes for achievement
                const frequencies = [523, 659, 784, 1047];
                let startTime = audioContext.currentTime;
                
                frequencies.forEach((freq, index) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(freq, startTime);
                    gainNode.gain.setValueAtTime(0.1, startTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.2);
                    
                    oscillator.start(startTime);
                    oscillator.stop(startTime + 0.2);
                    
                    startTime += 0.15;
                });
            } catch (e) {
                // Audio not supported
            }
        }

        // Enhanced notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.padding = '15px 20px';
            notification.style.borderRadius = '10px';
            notification.style.color = 'white';
            notification.style.fontWeight = 'bold';
            notification.style.zIndex = '10000';
            notification.style.direction = 'rtl';
            notification.style.minWidth = '250px';
            notification.style.boxShadow = '0 8px 25px rgba(0,0,0,0.2)';
            
            // Set colors based on type
            switch(type) {
                case 'success':
                    notification.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
                    break;
                case 'error':
                    notification.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
                    break;
                case 'achievement':
                    notification.style.background = 'linear-gradient(135deg, #f39c12, #e67e22)';
                    break;
                default:
                    notification.style.background = 'linear-gradient(135deg, #3498db, #2980b9)';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animate in
            notification.animate([
                { transform: 'translateX(100%)', opacity: 0 },
                { transform: 'translateX(0)', opacity: 1 }
            ], { duration: 300, easing: 'ease-out' });
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.animate([
                    { transform: 'translateX(0)', opacity: 1 },
                    { transform: 'translateX(100%)', opacity: 0 }
                ], { duration: 300, easing: 'ease-in' }).onfinish = () => {
                    document.body.removeChild(notification);
                };
            }, 3000);
        }

        // Toggle sound on/off
        function toggleSound() {
            soundEnabled = !soundEnabled;
            const soundToggle = document.getElementById('soundToggle');
            
            if (soundEnabled) {
                soundToggle.innerHTML = '<i class="fas fa-volume-up"></i>';
                soundToggle.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
                showNotification('تم تفعيل الصوت', 'success');
            } else {
                soundToggle.innerHTML = '<i class="fas fa-volume-mute"></i>';
                soundToggle.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
                showNotification('تم إيقاف الصوت', 'info');
            }
            
            localStorage.setItem('tasbeh-sound', soundEnabled);
        }

        // Scroll to top
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // Load user settings
        function loadSettings() {
            const savedSound = localStorage.getItem('tasbeh-sound');
            if (savedSound !== null) {
                soundEnabled = savedSound === 'true';
                const soundToggle = document.getElementById('soundToggle');
                if (!soundEnabled) {
                    soundToggle.innerHTML = '<i class="fas fa-volume-mute"></i>';
                    soundToggle.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
                }
            }
        }

        // Auto-save scroll position
        window.addEventListener('beforeunload', function() {
            localStorage.setItem('tasbehScrollPosition', window.pageYOffset);
        });

        window.addEventListener('load', function() {
            const scrollPosition = localStorage.getItem('tasbehScrollPosition');
            if (scrollPosition) {
                window.scrollTo(0, parseInt(scrollPosition));
                localStorage.removeItem('tasbehScrollPosition');
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Space bar to increment first phrase
            if (e.code === 'Space' && !e.target.matches('input, textarea')) {
                e.preventDefault();
                const firstButton = document.querySelector('.count-btn.main');
                if (firstButton) firstButton.click();
            }
            
            // R key to reset first phrase (with confirmation)
            if (e.key === 'r' || e.key === 'R') {
                const firstResetButton = document.querySelector('.reset-btn');
                if (firstResetButton) firstResetButton.click();
            }
        });

        // Add swipe gestures for mobile
        let touchStartX = 0;
        let touchEndX = 0;
        
        document.addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
        });
        
        document.addEventListener('touchend', function(e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });
        
        function handleSwipe() {
            const swipeThreshold = 50;
            const diff = touchStartX - touchEndX;
            
            if (Math.abs(diff) > swipeThreshold) {
                if (diff > 0) {
                    // Swipe left - scroll to next phrase
                    const containers = document.querySelectorAll('.phrase-container');
                    const currentVisible = Array.from(containers).find(container => {
                        const rect = container.getBoundingClientRect();
                        return rect.top >= 0 && rect.top <= window.innerHeight / 2;
                    });
                    
                    if (currentVisible) {
                        const nextContainer = currentVisible.nextElementSibling;
                        if (nextContainer && nextContainer.classList.contains('phrase-container')) {
                            nextContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                } else {
                    // Swipe right - scroll to previous phrase
                    const containers = document.querySelectorAll('.phrase-container');
                    const currentVisible = Array.from(containers).find(container => {
                        const rect = container.getBoundingClientRect();
                        return rect.top >= 0 && rect.top <= window.innerHeight / 2;
                    });
                    
                    if (currentVisible) {
                        const prevContainer = currentVisible.previousElementSibling;
                        if (prevContainer && prevContainer.classList.contains('phrase-container')) {
                            prevContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                }
            }
        }
    </script>
</body>
</html>
