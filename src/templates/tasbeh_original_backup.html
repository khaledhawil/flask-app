{% extends "base.html" %}

{% block title %}التسبيح الإلكتروني - Islamic Tasbeh{% endblock %}

{% block content %}
<!-- Simple Header -->
<div class="tasbeh-header">
    <div class="header-content">
        <h1 class="main-title">
            <i class="fas fa-prayer-hands"></i>
            التسبيح الإلكتروني
        </h1>
        <div class="verse-section">
            <p class="arabic-verse">وَاذْكُر رَّبَّكَ فِي نَفْسِكَ تَضَرُّعًا وَخِيفَةً</p>
            <p class="translation">"Remember your Lord within yourself in humility and in fear"</p>
        </div>
    </div>
</div>

<!-- Simple Stats -->
<div class="simple-stats">
    <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-infinity"></i></div>
        <div class="stat-value" id="totalDhikr">{{ total_dhikr or 0 }}</div>
        <div class="stat-label">إجمالي التسبيحات</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-calendar-day"></i></div>
        <div class="stat-value" id="todayCount">0</div>
        <div class="stat-label">تسبيحات اليوم</div>
    </div>
</div>

<!-- Main Tasbeh Interface -->
<div class="main-tasbeh-container">
    <!-- Phrase Selection -->
    <div class="phrase-selection">
        <h3>اختر الذكر</h3>
        <div class="phrases-grid">
            {% for phrase in phrases %}
            <div class="phrase-card" data-phrase="{{ phrase.text }}" data-id="{{ phrase.id }}" onclick="selectPhrase('{{ phrase.text }}', '{{ phrase.id }}', this)">
                <div class="phrase-text">{{ phrase.text }}</div>
                <div class="phrase-count">{{ phrase.count }}</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Counter Area -->
    <div class="counter-area">
        <div class="current-phrase-display">
            <div class="current-phrase" id="currentPhrase">سبحان الله</div>
        </div>

        <!-- Main Counter -->
        <div class="main-counter">
            <div class="counter-circle">
                <svg width="200" height="200">
                    <circle cx="100" cy="100" r="90" stroke="rgba(59, 130, 246, 0.2)" stroke-width="6" fill="none"/>
                    <circle cx="100" cy="100" r="90" stroke="#3b82f6" stroke-width="6" fill="none" 
                            stroke-dasharray="565" stroke-dashoffset="565" id="progressCircle"/>
                </svg>
                <div class="counter-display" id="counterDisplay">0</div>
            </div>
        </div>

        <!-- Counter Controls -->
        <div class="counter-controls">
            <button class="main-counter-btn" id="mainCountBtn" onclick="incrementCounter()">
                <i class="fas fa-hand-paper"></i>
                <span>تسبيح</span>
            </button>
            
            <div class="secondary-controls">
                <button class="secondary-btn" onclick="resetCurrentCounter()">
                    <i class="fas fa-redo"></i>
                    إعادة تعيين
                </button>
                <button class="secondary-btn" onclick="toggleSoundEffects()" id="soundToggle">
                    <i class="fas fa-volume-up"></i>
                    صوت
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Features Panel -->
<div class="advanced-features-panel">
    <!-- Goals and Challenges -->
    <div class="feature-section goals-section">
        <div class="section-header">
            <h3><i class="fas fa-bullseye"></i> الأهداف والتحديات</h3>
            <button class="expand-btn" onclick="toggleSection('goals')">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div class="section-content" id="goalsContent">
            <div class="goals-grid">
                <div class="goal-card daily-goal">
                    <div class="goal-header">
                        <i class="fas fa-sun"></i>
                        <span>هدف يومي</span>
                    </div>
                    <div class="goal-input">
                        <input type="number" id="dailyGoalInput" value="100" min="1" max="2000">
                        <button onclick="setDailyGoal()">تحديث</button>
                    </div>
                    <div class="goal-progress-bar">
                        <div class="progress-fill" id="dailyGoalProgress"></div>
                        <span id="dailyGoalText">0 / 100</span>
                    </div>
                </div>

                <div class="goal-card weekly-goal">
                    <div class="goal-header">
                        <i class="fas fa-calendar-week"></i>
                        <span>هدف أسبوعي</span>
                    </div>
                    <div class="goal-input">
                        <input type="number" id="weeklyGoalInput" value="700" min="1" max="14000">
                        <button onclick="setWeeklyGoal()">تحديث</button>
                    </div>
                    <div class="goal-progress-bar">
                        <div class="progress-fill" id="weeklyGoalProgress"></div>
                        <span id="weeklyGoalText">0 / 700</span>
                    </div>
                </div>
            </div>

            <!-- Achievement Badges -->
            <div class="achievements-section">
                <h4><i class="fas fa-medal"></i> الإنجازات المحققة</h4>
                <div class="achievements-grid" id="achievementsGrid">
                    <!-- Achievements will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics and Insights -->
    <div class="feature-section analytics-section">
        <div class="section-header">
            <h3><i class="fas fa-chart-line"></i> الإحصائيات والتحليل</h3>
            <button class="expand-btn" onclick="toggleSection('analytics')">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div class="section-content" id="analyticsContent">
            <div class="analytics-grid">
                <div class="analytics-card">
                    <h4>نشاط الأسبوع</h4>
                    <div class="week-chart" id="weekChart">
                        <!-- Week activity chart -->
                    </div>
                </div>
                <div class="analytics-card">
                    <h4>الأذكار المفضلة</h4>
                    <div class="favorites-list" id="favoritesList">
                        <!-- Top phrases list -->
                    </div>
                </div>
                <div class="analytics-card">
                    <h4>أوقات النشاط</h4>
                    <div class="activity-times" id="activityTimes">
                        <!-- Activity times chart -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Prayer Time Integration -->
    <div class="feature-section prayer-integration">
        <div class="section-header">
            <h3><i class="fas fa-mosque"></i> تذكير بأوقات الصلاة</h3>
            <button class="expand-btn" onclick="toggleSection('prayer')">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div class="section-content" id="prayerContent">
            <div class="prayer-reminders">
                <div class="reminder-setting">
                    <label>
                        <input type="checkbox" id="beforePrayerReminder">
                        تذكير قبل الصلاة بـ 10 دقائق
                    </label>
                </div>
                <div class="reminder-setting">
                    <label>
                        <input type="checkbox" id="afterPrayerReminder">
                        تذكير بالتسبيح بعد الصلاة
                    </label>
                </div>
                <div class="next-prayer-info" id="nextPrayerInfo">
                    <!-- Next prayer info will be displayed here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Notifications -->
<div id="notification-container"></div>

<!-- Statistics Modal -->
<div id="statisticsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-chart-bar"></i> الإحصائيات التفصيلية</h3>
            <button class="close-modal" onclick="closeStatisticsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="statisticsContent">
            <!-- Statistics content will be loaded here -->
        </div>
    </div>
</div>

<!-- Achievement Notification -->
<div id="achievementNotification" class="achievement-popup">
    <div class="achievement-content">
        <div class="achievement-icon" id="achievementIcon"></div>
        <div class="achievement-text">
            <h4 id="achievementTitle"></h4>
            <p id="achievementDescription"></p>
        </div>
    </div>
</div>

<style>
/* Enhanced Modern Tasbeh Styles */
:root {
    --primary-color: #3b82f6;
    --secondary-color: #8b5cf6;
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --error-color: #ef4444;
    --surface-color: #f8fafc;
    --card-bg: #ffffff;
    --text-primary: #1f2937;
    --text-secondary: #6b7280;
    --border-color: #e5e7eb;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    --gradient-primary: linear-gradient(135deg, #3b82f6, #8b5cf6);
    --gradient-success: linear-gradient(135deg, #10b981, #059669);
    --gradient-warm: linear-gradient(135deg, #f59e0b, #d97706);
}

[data-theme="dark"] {
    --surface-color: #0f172a;
    --card-bg: #1e293b;
    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --border-color: #334155;
}

* {
    box-sizing: border-box;
}

.tasbeh-header {
    background: var(--gradient-primary);
    color: white;
    padding: 3rem 2rem;
    text-align: center;
    margin-bottom: 2rem;
    border-radius: 0 0 2rem 2rem;
    position: relative;
    overflow: hidden;
}

.tasbeh-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 100" fill="rgba(255,255,255,0.1)"><polygon points="0,0 0,100 1000,0"/></svg>');
    background-size: cover;
}

.header-content {
    position: relative;
    z-index: 1;
}

.main-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
}

.verse-section {
    margin-top: 1.5rem;
}

.arabic-verse {
    font-family: 'Amiri', serif;
    font-size: 1.8rem;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.translation {
    font-size: 1rem;
    opacity: 0.9;
    font-style: italic;
}

/* Enhanced Stats Dashboard */
.enhanced-stats-dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
    padding: 0 2rem;
}

.stat-card {
    background: var(--card-bg);
    border-radius: 1.5rem;
    padding: 2rem;
    box-shadow: var(--shadow-lg);
    position: relative;
    overflow: hidden;
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-xl);
}

.stat-card.total-counter {
    background: var(--gradient-primary);
    color: white;
}

.stat-card.daily-counter {
    background: var(--gradient-success);
    color: white;
}

.stat-card.streak-counter {
    background: var(--gradient-warm);
    color: white;
}

.stat-card.achievement-counter {
    background: linear-gradient(135deg, #8b5cf6, #6366f1);
    color: white;
}

.stat-icon {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    opacity: 0.9;
}

.stat-content {
    text-align: center;
}

.stat-value {
    font-size: 3rem;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 0.5rem;
}

.stat-label {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.stat-sublabel {
    font-size: 0.9rem;
    opacity: 0.8;
}

/* Progress Ring Mini */
.daily-progress {
    position: absolute;
    top: 1rem;
    right: 1rem;
}

.progress-ring-mini svg {
    transform: rotate(-90deg);
}

/* Streak Flames Animation */
.streak-flames {
    position: absolute;
    bottom: 1rem;
    right: 1rem;
    display: flex;
    gap: 0.25rem;
}

.flame {
    width: 8px;
    height: 12px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
    animation: flame 1s infinite alternate;
}

.flame:nth-child(2) {
    animation-delay: 0.3s;
}

.flame:nth-child(3) {
    animation-delay: 0.6s;
}

@keyframes flame {
    0% { transform: scaleY(1) scaleX(1); }
    100% { transform: scaleY(1.2) scaleX(0.8); }
}

/* Enhanced Main Interface */
.enhanced-tasbeh-main {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 3rem;
    padding: 0 2rem;
    margin-bottom: 3rem;
}

/* Phrase Selection Panel */
.phrase-selection-panel {
    background: var(--card-bg);
    border-radius: 1.5rem;
    padding: 2rem;
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--border-color);
}

.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.panel-header h3 {
    color: var(--text-primary);
    font-size: 1.5rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.panel-controls {
    display: flex;
    gap: 0.5rem;
}

.control-btn {
    background: var(--surface-color);
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    padding: 0.75rem;
    cursor: pointer;
    transition: all 0.3s ease;
    color: var(--text-secondary);
}

.control-btn:hover {
    background: var(--primary-color);
    color: white;
    transform: translateY(-2px);
}

.phrases-grid-enhanced {
    display: grid;
    gap: 1rem;
    margin-bottom: 2rem;
}

.phrase-card-enhanced {
    background: var(--surface-color);
    border: 2px solid var(--border-color);
    border-radius: 1rem;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.phrase-card-enhanced:hover {
    border-color: var(--primary-color);
    transform: translateX(-5px);
    box-shadow: var(--shadow-md);
}

.phrase-card-enhanced.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.phrase-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.phrase-text {
    font-size: 1.1rem;
    font-weight: 600;
    font-family: 'Amiri', serif;
}

.phrase-count-badge {
    background: rgba(59, 130, 246, 0.1);
    color: var(--primary-color);
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.9rem;
    font-weight: 600;
}

.phrase-card-enhanced.active .phrase-count-badge {
    background: rgba(255, 255, 255, 0.2);
    color: white;
}

.phrase-progress {
    margin-bottom: 1rem;
}

.mini-progress-bar {
    background: var(--border-color);
    height: 4px;
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.progress-fill {
    background: var(--success-color);
    height: 100%;
    transition: width 0.3s ease;
}

.phrase-card-enhanced.active .progress-fill {
    background: rgba(255, 255, 255, 0.8);
}

.progress-percentage {
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.phrase-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.quick-add-btn {
    background: var(--success-color);
    color: white;
    border: none;
    border-radius: 0.5rem;
    padding: 0.25rem 0.75rem;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.quick-add-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.reset-phrase-btn {
    background: var(--error-color);
    color: white;
    border: none;
    border-radius: 0.5rem;
    padding: 0.25rem 0.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

/* Custom Phrase Section */
.custom-phrase-section {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid var(--border-color);
}

.custom-phrase-section h4 {
    color: var(--text-primary);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.custom-phrase-input {
    display: flex;
    gap: 0.5rem;
}

.custom-phrase-input input {
    flex: 1;
    padding: 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    background: var(--surface-color);
    color: var(--text-primary);
    font-family: 'Amiri', serif;
}

.add-phrase-btn {
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 0.75rem;
    padding: 0.75rem 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.add-phrase-btn:hover {
    background: #2563eb;
    transform: translateY(-2px);
}

/* Enhanced Counter Area */
.enhanced-counter-area {
    background: var(--card-bg);
    border-radius: 1.5rem;
    padding: 2rem;
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--border-color);
    text-align: center;
}

.current-phrase-display {
    margin-bottom: 2rem;
}

.phrase-container {
    text-align: center;
}

.current-phrase {
    font-family: 'Amiri', serif;
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.phrase-meaning {
    color: var(--text-secondary);
    font-size: 1.1rem;
    font-style: italic;
}

/* Main Counter Display */
.main-counter-display {
    margin-bottom: 3rem;
}

.counter-circle {
    position: relative;
    display: inline-block;
}

.counter-svg {
    transform: rotate(-90deg);
}

.counter-progress {
    transition: stroke-dashoffset 0.5s ease;
}

.counter-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}

.counter-number {
    font-size: 3.5rem;
    font-weight: 700;
    color: var(--primary-color);
    line-height: 1;
}

.counter-target {
    font-size: 1.2rem;
    color: var(--text-secondary);
    margin-top: 0.5rem;
}

/* Enhanced Controls */
.enhanced-counter-controls {
    margin-bottom: 2rem;
}

.main-counter-btn {
    background: var(--gradient-primary);
    color: white;
    border: none;
    border-radius: 2rem;
    padding: 1.5rem 3rem;
    font-size: 1.3rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    margin-bottom: 1rem;
    box-shadow: var(--shadow-lg);
}

.main-counter-btn:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: var(--shadow-xl);
}

.main-counter-btn:active {
    transform: translateY(-1px) scale(1.02);
}

.btn-content {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    position: relative;
    z-index: 1;
}

.btn-ripple {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: translate(-50%, -50%);
    transition: width 0.3s ease, height 0.3s ease;
}

.main-counter-btn:active .btn-ripple {
    width: 200px;
    height: 200px;
}

.secondary-controls {
    display: flex;
    gap: 1rem;
    justify-content: center;
}

.secondary-btn {
    background: var(--surface-color);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: 1rem;
    padding: 0.75rem 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.secondary-btn:hover {
    background: var(--primary-color);
    color: white;
    transform: translateY(-2px);
}

/* Milestone Indicators */
.milestone-indicators {
    display: flex;
    justify-content: center;
    gap: 2rem;
    margin-top: 2rem;
}

.milestone {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
}

.milestone-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 3px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    position: relative;
}

.milestone-circle.completed {
    border-color: var(--success-color);
    background: var(--success-color);
}

.milestone-circle.completed::after {
    content: '✓';
    color: white;
    font-weight: bold;
}

.milestone span {
    font-size: 0.9rem;
    color: var(--text-secondary);
    font-weight: 600;
}

/* Advanced Features Panel */
.advanced-features-panel {
    padding: 0 2rem;
    margin-bottom: 3rem;
}

.feature-section {
    background: var(--card-bg);
    border-radius: 1.5rem;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--border-color);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    cursor: pointer;
}

.section-header h3 {
    color: var(--text-primary);
    font-size: 1.3rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.expand-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 1.2rem;
    cursor: pointer;
    transition: transform 0.3s ease;
}

.expand-btn.expanded {
    transform: rotate(180deg);
}

.section-content {
    display: none;
}

.section-content.expanded {
    display: block;
    animation: fadeInDown 0.3s ease;
}

@keyframes fadeInDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Goals Section */
.goals-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.goal-card {
    background: var(--surface-color);
    border-radius: 1rem;
    padding: 1.5rem;
    border: 1px solid var(--border-color);
}

.goal-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    font-weight: 600;
    color: var(--text-primary);
}

.goal-input {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.goal-input input {
    flex: 1;
    padding: 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    background: var(--card-bg);
    color: var(--text-primary);
}

.goal-input button {
    background: var(--success-color);
    color: white;
    border: none;
    border-radius: 0.5rem;
    padding: 0.5rem 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.goal-progress-bar {
    background: var(--border-color);
    height: 8px;
    border-radius: 4px;
    overflow: hidden;
    position: relative;
    margin-bottom: 0.5rem;
}

.goal-progress-bar .progress-fill {
    height: 100%;
    background: var(--success-color);
    transition: width 0.3s ease;
}

.goal-progress-bar span {
    font-size: 0.9rem;
    color: var(--text-secondary);
}

/* Achievements Section */
.achievements-section {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid var(--border-color);
}

.achievements-section h4 {
    color: var(--text-primary);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.achievements-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 1rem;
}

.achievement-badge {
    background: var(--surface-color);
    border: 2px solid var(--border-color);
    border-radius: 1rem;
    padding: 1rem;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
}

.achievement-badge.earned {
    background: var(--gradient-primary);
    color: white;
    border-color: var(--primary-color);
    transform: scale(1.05);
}

.achievement-badge:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
}

.achievement-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.achievement-title {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.achievement-description {
    font-size: 0.8rem;
    opacity: 0.8;
}

/* Analytics Section */
.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

.analytics-card {
    background: var(--surface-color);
    border-radius: 1rem;
    padding: 1.5rem;
    border: 1px solid var(--border-color);
}

.analytics-card h4 {
    color: var(--text-primary);
    margin-bottom: 1rem;
    font-weight: 600;
}

/* Notifications */
#notification-container {
    position: fixed;
    top: 2rem;
    right: 2rem;
    z-index: 1000;
    pointer-events: none;
}

.notification {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 1rem;
    padding: 1rem;
    margin-bottom: 1rem;
    box-shadow: var(--shadow-lg);
    animation: slideInRight 0.3s ease;
    pointer-events: auto;
    max-width: 300px;
}

.notification.success {
    border-left: 4px solid var(--success-color);
}

.notification.error {
    border-left: 4px solid var(--error-color);
}

.notification.warning {
    border-left: 4px solid var(--warning-color);
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
}

.modal-content {
    background: var(--card-bg);
    margin: 5% auto;
    padding: 0;
    border-radius: 1.5rem;
    width: 90%;
    max-width: 800px;
    box-shadow: var(--shadow-xl);
    animation: modalFadeIn 0.3s ease;
}

.modal-header {
    padding: 2rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    color: var(--text-primary);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.close-modal {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 0.5rem;
    transition: all 0.3s ease;
}

.close-modal:hover {
    background: var(--surface-color);
    color: var(--text-primary);
}

.modal-body {
    padding: 2rem;
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

/* Achievement Notification */
.achievement-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    background: var(--gradient-primary);
    color: white;
    border-radius: 2rem;
    padding: 2rem;
    z-index: 1001;
    text-align: center;
    box-shadow: var(--shadow-xl);
    transition: transform 0.5s ease;
}

.achievement-popup.show {
    transform: translate(-50%, -50%) scale(1);
}

.achievement-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
}

.achievement-popup .achievement-icon {
    font-size: 4rem;
    animation: bounce 0.5s ease infinite alternate;
}

@keyframes bounce {
    from { transform: translateY(0); }
    to { transform: translateY(-10px); }
}

/* Responsive Design */
@media (max-width: 1024px) {
    .enhanced-tasbeh-main {
        grid-template-columns: 1fr;
        gap: 2rem;
    }
    
    .goals-grid {
        grid-template-columns: 1fr;
    }
    
    .analytics-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .enhanced-stats-dashboard {
        grid-template-columns: 1fr;
        padding: 0 1rem;
    }
    
    .enhanced-tasbeh-main {
        padding: 0 1rem;
    }
    
    .advanced-features-panel {
        padding: 0 1rem;
    }
    
    .main-title {
        font-size: 2rem;
    }
    
    .arabic-verse {
        font-size: 1.5rem;
    }
    
    .counter-number {
        font-size: 2.5rem;
    }
    
    .main-counter-btn {
        padding: 1rem 2rem;
        font-size: 1.1rem;
    }
    
    .milestone-indicators {
        gap: 1rem;
    }
    
    .milestone-circle {
        width: 30px;
        height: 30px;
    }
}

@media (max-width: 480px) {
    .tasbeh-header {
        padding: 2rem 1rem;
    }
    
    .stat-card {
        padding: 1.5rem;
    }
    
    .phrase-selection-panel,
    .enhanced-counter-area {
        padding: 1.5rem;
    }
    
    .main-counter-btn {
        width: 100%;
    }
    
    .secondary-controls {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .secondary-btn {
        width: 100%;
        justify-content: center;
    }
}
</style>
    text-align: center;
    font-size: 1.5rem;
}

.phrases-grid {
    display: grid;
    gap: 1rem;
}

.phrase-card {
    background: var(--card-bg);
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.phrase-card:hover {
    background: var(--primary-color);
    color: white;
    transform: translateX(-5px);
}

.phrase-card.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.phrase-text {
    font-size: 1.1rem;
    font-weight: 500;
}

.phrase-count {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: bold;
}

.counter-area {
    text-align: center;
    position: relative;
}

.current-phrase {
    font-size: 2rem;
    color: var(--text-color);
    margin-bottom: 2rem;
    font-family: 'Amiri', serif;
    font-weight: bold;
}

.counter-display {
    font-size: 4rem;
    font-weight: bold;
    color: var(--primary-color);
    margin: 2rem 0;
    text-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
}

.counter-controls {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin: 2rem 0;
}

.counter-btn {
    background: linear-gradient(135deg, var(--primary-color), #1e40af);
    color: white;
    border: none;
    border-radius: 50px;
    padding: 1rem 2rem;
    font-size: 1.2rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    min-width: 150px;
    justify-content: center;
}

.counter-btn:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
}

.reset-btn {
    background: linear-gradient(135deg, var(--error-color), #dc2626);
    color: white;
    border: none;
    border-radius: 50px;
    padding: 1rem 1.5rem;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.reset-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
}

.progress-ring {
    position: relative;
    margin: 2rem auto;
    width: 120px;
    height: 120px;
}

.progress-ring svg {
    transform: rotate(-90deg);
}

.progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 1.2rem;
    font-weight: bold;
    color: var(--text-color);
}

.features-panel {
    grid-column: 1 / -1;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
}

.feature-card {
    background: var(--card-bg);
    border: 2px solid var(--border-color);
    border-radius: 16px;
    padding: 2rem;
}

.feature-card h4 {
    color: var(--text-color);
    margin-bottom: 1.5rem;
    font-size: 1.3rem;
}

.goal-setting {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.goal-setting input {
    flex: 1;
    padding: 0.75rem;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    background: var(--input-bg);
    color: var(--text-color);
}

.goal-setting button, .custom-phrase button {
    background: var(--success-color);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.goal-setting button:hover, .custom-phrase button:hover {
    background: #16a34a;
    transform: translateY(-2px);
}

.progress-bar {
    background: var(--border-color);
    height: 8px;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.progress-fill {
    background: linear-gradient(90deg, var(--success-color), #16a34a);
    height: 100%;
    width: 0%;
    transition: width 0.3s ease;
}

.custom-phrase {
    display: flex;
    gap: 1rem;
}

.custom-phrase input {
    flex: 1;
    padding: 0.75rem;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    background: var(--input-bg);
    color: var(--text-color);
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.counter-btn:active {
    animation: bounce 0.3s ease;
}

@media (max-width: 768px) {
    .tasbeh-main {
        grid-template-columns: 1fr;
        gap: 2rem;
    }
    
    .stats-dashboard {
        grid-template-columns: 1fr;
    }
    
    .counter-controls {
        flex-direction: column;
        align-items: center;
    }
    
    .current-phrase {
        font-size: 1.5rem;
    }
    
    .counter-display {
        font-size: 3rem;
    }
}
</style>

<script>
// Enhanced Tasbeh JavaScript Implementation
let currentCount = 0;
let selectedPhraseId = null;
let selectedPhrase = 'سبحان الله';
let dailyGoal = 100;
let todayCount = 0;
let soundEnabled = true;
let hapticEnabled = true;
let achievements = [];
let streak = 1;
let achievementPoints = 0;
let lastActiveDate = new Date().toDateString();

// App state management
const appState = {
    soundEnabled: true,
    hapticEnabled: true,
    darkTheme: false,
    dailyGoal: 100,
    todayCount: 0,
    streak: 1,
    achievementPoints: 0,
    totalCount: 0,
    lastActiveDate: new Date().toDateString(),
    achievements: [],
    autoMode: false,
    autoInterval: null
};

// Initialize app components
function initializeApp() {
    loadTodayCount();
    updateGoalProgress();
    selectFirstPhrase();
    loadAchievements();
    updateStreakDisplay();
    setProgressRingAnimations();
}

// Load user settings from localStorage
function loadUserSettings() {
    const savedSound = localStorage.getItem('tasbeh_sound_enabled');
    const savedHaptic = localStorage.getItem('tasbeh_haptic_enabled');
    const savedTheme = localStorage.getItem('tasbeh_dark_theme');
    const savedGoal = localStorage.getItem('tasbeh_daily_goal');
    const savedStreak = localStorage.getItem('tasbeh_streak');
    const savedPoints = localStorage.getItem('tasbeh_achievement_points');
    
    if (savedSound !== null) {
        appState.soundEnabled = savedSound === 'true';
        soundEnabled = appState.soundEnabled;
        updateSoundToggleUI();
    }
    
    if (savedHaptic !== null) {
        appState.hapticEnabled = savedHaptic === 'true';
        hapticEnabled = appState.hapticEnabled;
        updateHapticToggleUI();
    }
    
    if (savedTheme !== null) {
        appState.darkTheme = savedTheme === 'true';
        applyTheme();
    }
    
    if (savedGoal) {
        appState.dailyGoal = parseInt(savedGoal);
        dailyGoal = appState.dailyGoal;
    }
    
    if (savedStreak) {
        appState.streak = parseInt(savedStreak);
        streak = appState.streak;
    }
    
    if (savedPoints) {
        appState.achievementPoints = parseInt(savedPoints);
        achievementPoints = appState.achievementPoints;
    }
}

// Save user settings to localStorage
function saveUserSettings() {
    localStorage.setItem('tasbeh_sound_enabled', appState.soundEnabled);
    localStorage.setItem('tasbeh_haptic_enabled', appState.hapticEnabled);
    localStorage.setItem('tasbeh_dark_theme', appState.darkTheme);
    localStorage.setItem('tasbeh_daily_goal', appState.dailyGoal);
    localStorage.setItem('tasbeh_streak', appState.streak);
    localStorage.setItem('tasbeh_achievement_points', appState.achievementPoints);
    localStorage.setItem('tasbeh_last_active_date', appState.lastActiveDate);
}

// Setup event listeners
function setupEventListeners() {
    // Keyboard shortcuts
    document.addEventListener('keydown', handleKeyboardShortcuts);
    
    // Touch gestures for mobile
    setupTouchGestures();
    
    // Window visibility for auto-pause
    document.addEventListener('visibilitychange', handleVisibilityChange);
    
    // Auto-save on page unload
    window.addEventListener('beforeunload', saveUserSettings);
}

// Handle keyboard shortcuts
function handleKeyboardShortcuts(e) {
    if (e.target.matches('input, textarea')) return;
    
    switch(e.code) {
        case 'Space':
        case 'Enter':
            e.preventDefault();
            incrementCounter();
            break;
        case 'KeyR':
            e.preventDefault();
            resetCounter();
            break;
        case 'KeyS':
            e.preventDefault();
            toggleSoundEffects();
            break;
        case 'KeyH':
            e.preventDefault();
            toggleHapticFeedback();
            break;
        case 'KeyM':
            e.preventDefault();
            openStatisticsModal();
            break;
        case 'Escape':
            e.preventDefault();
            closeAllModals();
            break;
    }
}

// Setup touch gestures for mobile
function setupTouchGestures() {
    let touchStartY = 0;
    let touchEndY = 0;
    let touchStartX = 0;
    let touchEndX = 0;
    
    document.addEventListener('touchstart', function(e) {
        touchStartY = e.changedTouches[0].screenY;
        touchStartX = e.changedTouches[0].screenX;
    });
    
    document.addEventListener('touchend', function(e) {
        touchEndY = e.changedTouches[0].screenY;
        touchEndX = e.changedTouches[0].screenX;
        handleSwipeGesture();
    });
    
    function handleSwipeGesture() {
        const swipeThreshold = 50;
        const verticalSwipe = touchStartY - touchEndY;
        const horizontalSwipe = touchStartX - touchEndX;
        
        if (Math.abs(verticalSwipe) > swipeThreshold) {
            if (verticalSwipe > 0) {
                // Swipe up - scroll to top
                scrollToTop();
            } else {
                // Swipe down - show achievement notification
                showRandomMotivation();
            }
        }
        
        if (Math.abs(horizontalSwipe) > swipeThreshold) {
            if (horizontalSwipe > 0) {
                // Swipe left - next phrase
                selectNextPhrase();
            } else {
                // Swipe right - previous phrase
                selectPreviousPhrase();
            }
        }
    }
}

// Select first phrase on load
function selectFirstPhrase() {
    const firstPhrase = document.querySelector('.phrase-card-enhanced');
    if (firstPhrase) {
        const phraseText = firstPhrase.getAttribute('data-phrase');
        const phraseId = firstPhrase.getAttribute('data-id');
        selectPhrase(phraseText, phraseId, firstPhrase);
    }
}

// Select next phrase
function selectNextPhrase() {
    const currentActive = document.querySelector('.phrase-card-enhanced.active');
    if (currentActive) {
        const nextPhrase = currentActive.nextElementSibling;
        if (nextPhrase && nextPhrase.classList.contains('phrase-card-enhanced')) {
            const phraseText = nextPhrase.getAttribute('data-phrase');
            const phraseId = nextPhrase.getAttribute('data-id');
            selectPhrase(phraseText, phraseId, nextPhrase);
        }
    }
}

// Select previous phrase
function selectPreviousPhrase() {
    const currentActive = document.querySelector('.phrase-card-enhanced.active');
    if (currentActive) {
        const prevPhrase = currentActive.previousElementSibling;
        if (prevPhrase && prevPhrase.classList.contains('phrase-card-enhanced')) {
            const phraseText = prevPhrase.getAttribute('data-phrase');
            const phraseId = prevPhrase.getAttribute('data-id');
            selectPhrase(phraseText, phraseId, prevPhrase);
        }
    }
}

// Enhanced phrase selection
function selectPhrase(phrase, phraseId, element) {
    selectedPhrase = phrase;
    selectedPhraseId = phraseId;
    
    // Update current phrase display
    document.getElementById('currentPhrase').textContent = phrase;
    
    // Add phrase meaning
    const meanings = {
        'سبحان الله': 'Glory be to Allah',
        'الحمد لله': 'Praise be to Allah',
        'لا إله إلا الله': 'There is no god but Allah',
        'الله أكبر': 'Allah is the Greatest',
        'أستغفر الله': 'I seek forgiveness from Allah',
        'لا حول ولا قوة إلا بالله': 'There is no power except with Allah'
    };
    
    const meaningElement = document.getElementById('phraseMeaning');
    if (meaningElement) {
        meaningElement.textContent = meanings[phrase] || 'Islamic remembrance';
    }
    
    // Update active state with animation
    document.querySelectorAll('.phrase-card-enhanced').forEach(card => {
        card.classList.remove('active');
    });
    
    if (element) {
        element.classList.add('active');
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    // Reset counter for new phrase
    currentCount = 0;
    updateCounterDisplay();
    updateProgress();
    
    // Play selection sound
    playSelectionSound();
    
    // Visual feedback
    if (element) {
        element.style.transform = 'scale(1.05)';
        setTimeout(() => {
            element.style.transform = '';
        }, 200);
    }
}

// Enhanced counter increment with animations and effects
function incrementCounter() {
    currentCount++;
    todayCount++;
    appState.todayCount = todayCount;
    appState.totalCount++;
    
    updateCounterDisplay();
    updateTodayDisplay();
    updateProgress();
    updateGoalProgress();
    updateDailyProgressRing();
    saveTodayCount();
    
    // Server update
    updateServerCount();
    
    // Effects
    playCountSound();
    triggerHapticFeedback();
    showFloatingNumber();
    addRippleEffect();
    
    // Check achievements
    checkMilestones();
    
    // Update achievement points
    appState.achievementPoints++;
    achievementPoints = appState.achievementPoints;
    updateAchievementPointsDisplay();
    
    saveUserSettings();
}

// Update counter display with animation
function updateCounterDisplay() {
    const counterElement = document.getElementById('counterDisplay');
    if (counterElement) {
        // Animate number change
        counterElement.style.transform = 'scale(1.2)';
        counterElement.textContent = currentCount;
        
        setTimeout(() => {
            counterElement.style.transform = 'scale(1)';
        }, 150);
    }
}

// Update today's count display
function updateTodayDisplay() {
    const todayElement = document.getElementById('todayCount');
    if (todayElement) {
        todayElement.textContent = todayCount;
    }
}

// Update all displays
function updateAllDisplays() {
    updateCounterDisplay();
    updateTodayDisplay();
    updateProgress();
    updateGoalProgress();
    updateStreakDisplay();
    updateAchievementPointsDisplay();
    updateDailyProgressRing();
}

// Server communication for count updates
function updateServerCount() {
    if (!selectedPhraseId) return;
    
    fetch('/increment-dhikr', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            phrase_id: selectedPhraseId,
            phrase: selectedPhrase
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update total count
            const totalElement = document.getElementById('totalDhikr');
            if (totalElement) {
                animateNumberChange(totalElement, data.total_dhikr);
            }
            
            // Update phrase count in card
            updatePhraseCardCount(data.phrase_count);
        }
    })
    .catch(error => {
        console.error('Error updating server:', error);
        showNotification('خطأ في الاتصال بالخادم', 'error');
    });
}

// Animate number change
function animateNumberChange(element, newValue) {
    const currentValue = parseInt(element.textContent) || 0;
    const increment = Math.ceil((newValue - currentValue) / 10);
    let current = currentValue;
    
    const animation = setInterval(() => {
        current += increment;
        if (current >= newValue) {
            current = newValue;
            clearInterval(animation);
        }
        element.textContent = current;
    }, 50);
}

// Update phrase card count
function updatePhraseCardCount(newCount) {
    const activeCard = document.querySelector('.phrase-card-enhanced.active');
    if (activeCard) {
        const countBadge = activeCard.querySelector('.phrase-count-badge');
        if (countBadge) {
            animateNumberChange(countBadge, newCount);
        }
        
        // Update progress bar in card
        const progressFill = activeCard.querySelector('.progress-fill');
        if (progressFill) {
            const percentage = (newCount % 100);
            progressFill.style.width = percentage + '%';
        }
        
        const progressPercentage = activeCard.querySelector('.progress-percentage');
        if (progressPercentage) {
            progressPercentage.textContent = (newCount % 100) + '%';
        }
    }
}

// Enhanced progress update with SVG animation
function updateProgress() {
    const target = 33; // Standard tasbeh round
    const percentage = (currentCount % target) / target;
    const circumference = 2 * Math.PI * 90; // Updated radius
    const offset = circumference - (percentage * circumference);
    
    const progressCircle = document.getElementById('progressCircle');
    if (progressCircle) {
        progressCircle.style.strokeDashoffset = offset;
        progressCircle.style.transition = 'stroke-dashoffset 0.3s ease';
    }
    
    const progressText = document.getElementById('progressText');
    if (progressText) {
        progressText.textContent = `${currentCount % target}/${target}`;
    }
    
    // Update progress percentage
    const progressPercentage = document.getElementById('progressPercentage');
    if (progressPercentage) {
        progressPercentage.textContent = Math.round(percentage * 100) + '%';
    }
}

// Quick increment functions
function quickIncrement(phrase, amount) {
    if (selectedPhrase !== phrase) {
        // Switch to this phrase first
        const phraseCard = document.querySelector(`[data-phrase="${phrase}"]`);
        if (phraseCard) {
            selectPhrase(phrase, phraseCard.getAttribute('data-id'), phraseCard);
        }
    }
    
    // Add the amount
    for (let i = 0; i < amount; i++) {
        setTimeout(() => {
            incrementCounter();
        }, i * 50); // Staggered animation
    }
    
    showNotification(`تم إضافة ${amount} تسبيحة`, 'success');
}

// Reset phrase count
function resetPhrase(phrase) {
    if (confirm(`هل أنت متأكد من إعادة تعيين عداد "${phrase}"؟`)) {
        // Reset current counter if this is the selected phrase
        if (selectedPhrase === phrase) {
            currentCount = 0;
            updateCounterDisplay();
            updateProgress();
        }
        
        // Reset server count
        fetch('/reset-phrase', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ phrase: phrase })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update phrase card
                const phraseCard = document.querySelector(`[data-phrase="${phrase}"]`);
                if (phraseCard) {
                    const countBadge = phraseCard.querySelector('.phrase-count-badge');
                    const progressFill = phraseCard.querySelector('.progress-fill');
                    const progressPercentage = phraseCard.querySelector('.progress-percentage');
                    
                    if (countBadge) countBadge.textContent = '0';
                    if (progressFill) progressFill.style.width = '0%';
                    if (progressPercentage) progressPercentage.textContent = '0%';
                }
                
                showNotification('تم إعادة تعيين العداد', 'success');
            }
        })
        .catch(error => {
            console.error('Error resetting phrase:', error);
            showNotification('خطأ في إعادة التعيين', 'error');
        });
    }
}

// Reset current counter
function resetCounter() {
    if (confirm('هل أنت متأكد من إعادة تعيين العداد الحالي؟')) {
        currentCount = 0;
        updateCounterDisplay();
        updateProgress();
        showNotification('تم إعادة تعيين العداد', 'info');
    }
}

// Goal management
function setDailyGoal() {
    const goalInput = document.getElementById('dailyGoal');
    if (goalInput) {
        const newGoal = parseInt(goalInput.value);
        if (newGoal > 0 && newGoal <= 10000) {
            appState.dailyGoal = newGoal;
            dailyGoal = newGoal;
            updateGoalProgress();
            saveUserSettings();
            showNotification(`تم تحديد الهدف اليومي: ${newGoal}`, 'success');
        } else {
            showNotification('يرجى إدخال هدف صحيح (1-10000)', 'error');
        }
    }
}

// Update goal progress
function updateGoalProgress() {
    const percentage = Math.min((todayCount / dailyGoal) * 100, 100);
    
    const goalProgress = document.getElementById('goalProgress');
    if (goalProgress) {
        goalProgress.style.width = percentage + '%';
    }
    
    const goalText = document.getElementById('goalText');
    if (goalText) {
        goalText.textContent = `${todayCount} / ${dailyGoal}`;
    }
    
    // Update daily progress ring
    updateDailyProgressRing();
    
    // Check if goal is reached
    if (todayCount >= dailyGoal && percentage >= 100) {
        showGoalAchievement();
    }
}

// Update daily progress ring
function updateDailyProgressRing() {
    const progressRing = document.getElementById('dailyProgressRing');
    if (progressRing) {
        const percentage = Math.min((todayCount / dailyGoal), 1);
        const circumference = 2 * Math.PI * 18;
        const offset = circumference - (percentage * circumference);
        progressRing.style.strokeDashoffset = offset;
    }
}

// Show goal achievement
function showGoalAchievement() {
    if (!document.querySelector('.goal-achievement-shown')) {
        showAchievementNotification(
            '🎯',
            'هدف محقق!',
            `مبروك! لقد حققت هدفك اليومي ${dailyGoal} تسبيحة`
        );
        playAchievementSound();
        
        // Mark as shown to prevent repeated notifications
        document.body.classList.add('goal-achievement-shown');
        setTimeout(() => {
            document.body.classList.remove('goal-achievement-shown');
        }, 5000);
    }
}

// Custom phrase management
function addCustomPhrase() {
    const input = document.getElementById('customPhraseInput');
    if (!input) return;
    
    const phrase = input.value.trim();
    if (!phrase) {
        showNotification('يرجى إدخال نص الذكر', 'error');
        return;
    }
    
    if (phrase.length > 100) {
        showNotification('النص طويل جداً (أقصى حد 100 حرف)', 'error');
        return;
    }
    
    fetch('/add-custom-phrase', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ phrase: phrase })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('تم إضافة الذكر المخصص', 'success');
            input.value = '';
            
            // Reload page to show new phrase
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showNotification(data.message || 'خطأ في إضافة الذكر', 'error');
        }
    })
    .catch(error => {
        console.error('Error adding custom phrase:', error);
        showNotification('خطأ في الاتصال', 'error');
    });
}

// Sound effects
function toggleSoundEffects() {
    appState.soundEnabled = !appState.soundEnabled;
    soundEnabled = appState.soundEnabled;
    updateSoundToggleUI();
    saveUserSettings();
    
    if (soundEnabled) {
        playTestSound();
        showNotification('تم تفعيل الأصوات', 'success');
    } else {
        showNotification('تم إيقاف الأصوات', 'info');
    }
}

// Update sound toggle UI
function updateSoundToggleUI() {
    const soundToggle = document.getElementById('soundToggle');
    if (soundToggle) {
        const icon = soundToggle.querySelector('i');
        if (soundEnabled) {
            icon.className = 'fas fa-volume-up';
            soundToggle.classList.remove('muted');
        } else {
            icon.className = 'fas fa-volume-mute';
            soundToggle.classList.add('muted');
        }
    }
}

// Play count sound
function playCountSound() {
    if (!soundEnabled) return;
    
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.1);
    } catch (e) {
        console.log('Audio not supported');
    }
}

// Play selection sound
function playSelectionSound() {
    if (!soundEnabled) return;
    
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.15);
    } catch (e) {
        console.log('Audio not supported');
    }
}

// Play achievement sound
function playAchievementSound() {
    if (!soundEnabled) return;
    
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const frequencies = [523, 659, 784, 1047]; // C major chord
        let startTime = audioContext.currentTime;
        
        frequencies.forEach((freq, index) => {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(freq, startTime);
            gainNode.gain.setValueAtTime(0.1, startTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.3);
            
            oscillator.start(startTime);
            oscillator.stop(startTime + 0.3);
            
            startTime += 0.1;
        });
    } catch (e) {
        console.log('Audio not supported');
    }
}

// Play test sound
function playTestSound() {
    if (!soundEnabled) return;
    
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
    } catch (e) {
        console.log('Audio not supported');
    }
}

// Haptic feedback
function toggleHapticFeedback() {
    appState.hapticEnabled = !appState.hapticEnabled;
    hapticEnabled = appState.hapticEnabled;
    updateHapticToggleUI();
    saveUserSettings();
    
    if (hapticEnabled) {
        triggerHapticFeedback();
        showNotification('تم تفعيل الاهتزاز', 'success');
    } else {
        showNotification('تم إيقاف الاهتزاز', 'info');
    }
}

// Update haptic toggle UI
function updateHapticToggleUI() {
    const hapticToggle = document.getElementById('hapticToggle');
    if (hapticToggle) {
        if (hapticEnabled) {
            hapticToggle.classList.add('active');
        } else {
            hapticToggle.classList.remove('active');
        }
    }
}

// Trigger haptic feedback
function triggerHapticFeedback() {
    if (hapticEnabled && navigator.vibrate) {
        navigator.vibrate(50);
    }
}

// Visual effects
function showFloatingNumber() {
    const button = document.getElementById('countBtn');
    if (!button) return;
    
    const floating = document.createElement('div');
    floating.textContent = '+1';
    floating.style.position = 'absolute';
    floating.style.fontSize = '1.5rem';
    floating.style.fontWeight = 'bold';
    floating.style.color = '#10b981';
    floating.style.pointerEvents = 'none';
    floating.style.zIndex = '1000';
    floating.style.animation = 'floatUp 1s ease-out forwards';
    
    const rect = button.getBoundingClientRect();
    floating.style.left = (rect.left + rect.width / 2) + 'px';
    floating.style.top = rect.top + 'px';
    
    document.body.appendChild(floating);
    
    setTimeout(() => {
        if (document.body.contains(floating)) {
            document.body.removeChild(floating);
        }
    }, 1000);
}

// Add ripple effect
function addRippleEffect() {
    const button = document.getElementById('countBtn');
    if (!button) return;
    
    button.style.transform = 'scale(0.95)';
    setTimeout(() => {
        button.style.transform = 'scale(1)';
    }, 100);
}

// Progress ring animations
function setProgressRingAnimations() {
    const progressCircle = document.getElementById('progressCircle');
    if (progressCircle) {
        const circumference = 2 * Math.PI * 90;
        progressCircle.style.strokeDasharray = circumference;
        progressCircle.style.strokeDashoffset = circumference;
    }
    
    const dailyProgressRing = document.getElementById('dailyProgressRing');
    if (dailyProgressRing) {
        const circumference = 2 * Math.PI * 18;
        dailyProgressRing.style.strokeDasharray = circumference;
        dailyProgressRing.style.strokeDashoffset = circumference;
    }
}

// Achievement system
function checkMilestones() {
    const milestones = [10, 33, 50, 100, 300, 500, 1000];
    
    milestones.forEach(milestone => {
        if (currentCount === milestone) {
            showMilestoneAchievement(milestone);
        }
        
        if (todayCount === milestone) {
            showDailyMilestoneAchievement(milestone);
        }
    });
    
    // Check for special achievements
    checkSpecialAchievements();
}

// Show milestone achievement
function showMilestoneAchievement(milestone) {
    showAchievementNotification(
        '🎯',
        'إنجاز جديد!',
        `ممتاز! وصلت إلى ${milestone} تسبيحة متتالية`
    );
    
    appState.achievementPoints += milestone;
    achievementPoints = appState.achievementPoints;
    updateAchievementPointsDisplay();
    
    playAchievementSound();
    saveUserSettings();
}

// Show daily milestone achievement
function showDailyMilestoneAchievement(milestone) {
    showAchievementNotification(
        '⭐',
        'إنجاز يومي!',
        `رائع! أكملت ${milestone} تسبيحة اليوم`
    );
    
    appState.achievementPoints += Math.floor(milestone / 10);
    achievementPoints = appState.achievementPoints;
    updateAchievementPointsDisplay();
}

// Check special achievements
function checkSpecialAchievements() {
    // Perfect round achievement (33, 66, 99, etc.)
    if (currentCount % 33 === 0 && currentCount > 0) {
        showAchievementNotification(
            '🔥',
            'جولة كاملة!',
            `أحسنت! أكملت ${currentCount / 33} جولة من التسبيح`
        );
    }
    
    // Early bird achievement (if counting before 6 AM)
    const hour = new Date().getHours();
    if (hour < 6 && todayCount === 1) {
        showAchievementNotification(
            '🌅',
            'المبكر المبارك!',
            'بارك الله فيك! بدأت التسبيح في وقت مبكر'
        );
    }
    
    // Night worshipper (if counting after 10 PM)
    if (hour >= 22 && todayCount >= 100) {
        showAchievementNotification(
            '🌙',
            'قائم الليل!',
            'جزاك الله خيراً! تسبيح في وقت متأخر'
        );
    }
}

// Show achievement notification
function showAchievementNotification(icon, title, description) {
    const notification = document.getElementById('achievementNotification');
    if (!notification) return;
    
    const iconElement = document.getElementById('achievementIcon');
    const titleElement = document.getElementById('achievementTitle');
    const descriptionElement = document.getElementById('achievementDescription');
    
    if (iconElement) iconElement.textContent = icon;
    if (titleElement) titleElement.textContent = title;
    if (descriptionElement) descriptionElement.textContent = description;
    
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 5000);
}

// Update streak display
function updateStreakDisplay() {
    const streakElement = document.getElementById('streak');
    if (streakElement) {
        streakElement.textContent = appState.streak;
    }
}

// Update achievement points display
function updateAchievementPointsDisplay() {
    const pointsElement = document.getElementById('achievementPoints');
    if (pointsElement) {
        animateNumberChange(pointsElement, appState.achievementPoints);
    }
}

// Check daily streak
function checkDailyStreak() {
    const today = new Date().toDateString();
    const yesterday = new Date(Date.now() - 86400000).toDateString();
    const lastActive = localStorage.getItem('tasbeh_last_active_date');
    
    if (lastActive === yesterday) {
        // Streak continues
        appState.streak++;
    } else if (lastActive !== today) {
        // Streak broken
        appState.streak = 1;
    }
    
    appState.lastActiveDate = today;
    saveUserSettings();
    updateStreakDisplay();
}

// Load achievements
function loadAchievements() {
    const savedAchievements = localStorage.getItem('tasbeh_achievements');
    if (savedAchievements) {
        appState.achievements = JSON.parse(savedAchievements);
        achievements = appState.achievements;
    }
}

// Save achievements
function saveAchievements() {
    localStorage.setItem('tasbeh_achievements', JSON.stringify(appState.achievements));
}

// Statistics modal
function openStatisticsModal() {
    const modal = document.getElementById('statisticsModal');
    if (modal) {
        loadStatisticsData();
        modal.style.display = 'block';
    }
}

// Close statistics modal
function closeStatisticsModal() {
    const modal = document.getElementById('statisticsModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Close all modals
function closeAllModals() {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        modal.style.display = 'none';
    });
}

// Load statistics data
function loadStatisticsData() {
    fetch('/tasbeh/statistics')
        .then(response => response.json())
        .then(data => {
            const content = document.getElementById('statisticsContent');
            if (content && data.success) {
                content.innerHTML = generateStatisticsHTML(data.statistics);
            }
        })
        .catch(error => {
            console.error('Error loading statistics:', error);
        });
}

// Generate statistics HTML
function generateStatisticsHTML(stats) {
    return `
        <div class="stats-grid">
            <div class="stat-item">
                <h4>إجمالي التسبيحات</h4>
                <div class="stat-value">${stats.total_count || 0}</div>
            </div>
            <div class="stat-item">
                <h4>تسبيحات اليوم</h4>
                <div class="stat-value">${stats.today_count || 0}</div>
            </div>
            <div class="stat-item">
                <h4>متوسط يومي</h4>
                <div class="stat-value">${stats.daily_average || 0}</div>
            </div>
            <div class="stat-item">
                <h4>أيام متتالية</h4>
                <div class="stat-value">${appState.streak}</div>
            </div>
            <div class="stat-item">
                <h4>نقاط الإنجاز</h4>
                <div class="stat-value">${appState.achievementPoints}</div>
            </div>
            <div class="stat-item">
                <h4>الذكر المفضل</h4>
                <div class="stat-value">${stats.favorite_phrase || 'سبحان الله'}</div>
            </div>
        </div>
    `;
}

// Notification system
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <span class="notification-message">${message}</span>
            <button class="notification-close" onclick="this.parentElement.parentElement.remove()">×</button>
        </div>
    `;
    
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        max-width: 300px;
        animation: slideInRight 0.3s ease;
        direction: rtl;
    `;
    
    // Set colors based on type
    const colors = {
        success: '#10b981',
        error: '#ef4444',
        warning: '#f59e0b',
        info: '#3b82f6'
    };
    
    notification.style.borderLeft = `4px solid ${colors[type] || colors.info}`;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (document.body.contains(notification)) {
            notification.style.animation = 'slideOutRight 0.3s ease forwards';
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }
    }, 4000);
}

// Random motivation
function showRandomMotivation() {
    const motivations = [
        'استمر في الذكر، بارك الله فيك',
        'كل تسبيحة لها أجر عظيم',
        'الذكر طمأنينة للقلوب',
        'أحسنت! واصل التسبيح',
        'بالذكر تطمئن القلوب',
        'جزاك الله خيراً على المواصلة'
    ];
    
    const randomMotivation = motivations[Math.floor(Math.random() * motivations.length)];
    showNotification(randomMotivation, 'info');
}

// Utility functions
function scrollToTop() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}

function handleVisibilityChange() {
    if (document.hidden) {
        // Page is hidden, pause auto mode if active
        if (appState.autoMode && appState.autoInterval) {
            clearInterval(appState.autoInterval);
        }
    } else {
        // Page is visible, resume auto mode if it was active
        if (appState.autoMode) {
            startAutoMode();
        }
    }
}

// Reset current counter function
function resetCurrentCounter() {
    if (confirm('هل تريد إعادة تعيين العداد الحالي؟\nAre you sure you want to reset the current counter?')) {
        currentCount = 0;
        updateCounterDisplay();
        updateProgress();
        showNotification('تم إعادة تعيين العداد', 'success');
        saveUserSettings();
    }
}

// Auto mode functionality
function toggleAutoMode() {
    appState.autoMode = !appState.autoMode;
    
    if (appState.autoMode) {
        startAutoMode();
        showNotification('تم تفعيل الوضع التلقائي', 'info');
    } else {
        stopAutoMode();
        showNotification('تم إيقاف الوضع التلقائي', 'info');
    }
}

function startAutoMode() {
    if (appState.autoInterval) {
        clearInterval(appState.autoInterval);
    }
    
    appState.autoInterval = setInterval(() => {
        incrementCounter();
    }, 2000); // Auto increment every 2 seconds
}

function stopAutoMode() {
    if (appState.autoInterval) {
        clearInterval(appState.autoInterval);
        appState.autoInterval = null;
    }
}

// Data persistence
function loadTodayCount() {
    const today = new Date().toDateString();
    const saved = localStorage.getItem(`tasbeh_${today}`);
    todayCount = saved ? parseInt(saved) : 0;
    appState.todayCount = todayCount;
    
    updateTodayDisplay();
    
    // Load daily goal
    const savedGoal = localStorage.getItem('tasbeh_daily_goal');
    if (savedGoal) {
        appState.dailyGoal = parseInt(savedGoal);
        dailyGoal = appState.dailyGoal;
        
        const goalInput = document.getElementById('dailyGoal');
        if (goalInput) {
            goalInput.value = dailyGoal;
        }
    }
}

function saveTodayCount() {
    const today = new Date().toDateString();
    localStorage.setItem(`tasbeh_${today}`, todayCount);
}

// Apply theme
function applyTheme() {
    if (appState.darkTheme) {
        document.body.classList.add('dark-theme');
    } else {
        document.body.classList.remove('dark-theme');
    }
}

// Initialize touch events for better mobile experience
function initializeTouchEvents() {
    const countBtn = document.getElementById('countBtn');
    if (countBtn) {
        // Prevent double-tap zoom on the count button
        countBtn.addEventListener('touchend', function(e) {
            e.preventDefault();
            incrementCounter();
        });
    }
}

// Add CSS animations dynamically
function addDynamicStyles() {
    const style = document.createElement('style');
    style.textContent = `
        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-60px) scale(1.2);
            }
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .notification {
            font-family: 'Cairo', sans-serif;
        }
        
        .notification-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        
        .notification-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }
        
        .notification-close:hover {
            opacity: 1;
        }
        
        .phrase-card-enhanced.active {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
            border: 2px solid var(--primary-color);
        }
        
        .control-btn.active {
            background: var(--success-color);
            color: white;
        }
        
        .control-btn.muted {
            background: var(--error-color);
            opacity: 0.7;
        }
        
        #achievementNotification {
            transform: translateX(100%);
            transition: transform 0.5s ease;
        }
        
        #achievementNotification.show {
            transform: translateX(0);
        }
    `;
    document.head.appendChild(style);
}

// Initialize everything when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Main app initialization
    initializeApp();
    loadUserSettings();
    updateAllDisplays();
    setupEventListeners();
    checkDailyStreak();
    
    // Additional initialization
    addDynamicStyles();
    initializeTouchEvents();
});
</script>
{% endblock %}