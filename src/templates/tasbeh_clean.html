{% extends "base.html" %}

{% block title %}التسبيح الإلكتروني - Islamic Tasbeh{% endblock %}

{% block content %}
<!-- Simple Header -->
<div class="tasbeh-header">
    <div class="header-content">
        <h1 class="main-title">
            <i class="fas fa-prayer-hands"></i>
            التسبيح الإلكتروني
        </h1>
        <div class="verse-section">
            <p class="arabic-verse">وَاذْكُر رَّبَّكَ فِي نَفْسِكَ تَضَرُّعًا وَخِيفَةً</p>
            <p class="translation">"Remember your Lord within yourself in humility and in fear"</p>
        </div>
    </div>
</div>

<!-- Simple Stats -->
<div class="simple-stats">
    <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-infinity"></i></div>
        <div class="stat-value" id="totalDhikr">{{ total_dhikr or 0 }}</div>
        <div class="stat-label">إجمالي التسبيحات</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-calendar-day"></i></div>
        <div class="stat-value" id="todayCount">0</div>
        <div class="stat-label">تسبيحات اليوم</div>
    </div>
</div>

<!-- Main Tasbeh Interface -->
<div class="main-tasbeh-container">
    <!-- Phrase Selection -->
    <div class="phrase-selection">
        <h3>اختر الذكر</h3>
        <div class="phrases-grid">
            {% for phrase in phrases %}
            <div class="phrase-card" data-phrase="{{ phrase.text }}" data-id="{{ phrase.id }}" onclick="selectPhrase('{{ phrase.text }}', '{{ phrase.id }}', this)">
                <div class="phrase-text">{{ phrase.text }}</div>
                <div class="phrase-count">{{ phrase.count }}</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Counter Area -->
    <div class="counter-area">
        <div class="current-phrase-display">
            <div class="current-phrase" id="currentPhrase">سبحان الله</div>
        </div>

        <!-- Main Counter -->
        <div class="main-counter">
            <div class="counter-circle">
                <svg width="200" height="200">
                    <circle cx="100" cy="100" r="90" stroke="rgba(59, 130, 246, 0.2)" stroke-width="6" fill="none"/>
                    <circle cx="100" cy="100" r="90" stroke="#3b82f6" stroke-width="6" fill="none" 
                            stroke-dasharray="565" stroke-dashoffset="565" id="progressCircle"/>
                </svg>
                <div class="counter-display" id="counterDisplay">0</div>
            </div>
        </div>

        <!-- Counter Controls -->
        <div class="counter-controls">
            <button class="main-counter-btn" id="mainCountBtn" onclick="incrementCounter()">
                <i class="fas fa-hand-paper"></i>
                <span>تسبيح</span>
            </button>
            
            <div class="secondary-controls">
                <button class="secondary-btn" onclick="resetCurrentCounter()">
                    <i class="fas fa-redo"></i>
                    إعادة تعيين
                </button>
                <button class="secondary-btn" onclick="toggleSoundEffects()" id="soundToggle">
                    <i class="fas fa-volume-up"></i>
                    صوت
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Clean Tasbeh Styles */
:root {
    --primary-color: #3b82f6;
    --success-color: #10b981;
    --card-bg: #ffffff;
    --text-primary: #1f2937;
    --text-secondary: #6b7280;
    --border-color: #e5e7eb;
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

[data-theme="dark"] {
    --card-bg: #1e293b;
    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --border-color: #334155;
}

.tasbeh-header {
    background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    color: white;
    padding: 2rem;
    text-align: center;
    margin-bottom: 2rem;
    border-radius: 0 0 1rem 1rem;
}

.main-title {
    font-size: 2rem;
    font-weight: 600;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.arabic-verse {
    font-family: 'Amiri', serif;
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}

.translation {
    font-size: 0.9rem;
    opacity: 0.9;
    font-style: italic;
}

/* Simple Stats */
.simple-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
    padding: 0 1rem;
}

.stat-card {
    background: var(--card-bg);
    border-radius: 1rem;
    padding: 1.5rem;
    text-align: center;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
}

.stat-icon {
    font-size: 2rem;
    color: var(--primary-color);
    margin-bottom: 0.5rem;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
}

.stat-label {
    font-size: 0.9rem;
    color: var(--text-secondary);
}

/* Main Container */
.main-tasbeh-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 1rem;
}

/* Phrase Selection */
.phrase-selection {
    margin-bottom: 2rem;
}

.phrase-selection h3 {
    text-align: center;
    color: var(--text-primary);
    margin-bottom: 1rem;
    font-size: 1.25rem;
}

.phrases-grid {
    display: grid;
    gap: 0.75rem;
}

.phrase-card {
    background: var(--card-bg);
    border: 2px solid var(--border-color);
    border-radius: 0.75rem;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.phrase-card:hover {
    background: var(--primary-color);
    color: white;
    transform: translateX(-3px);
}

.phrase-card.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.phrase-text {
    font-size: 1.1rem;
    font-weight: 500;
}

.phrase-count {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.9rem;
    font-weight: bold;
}

/* Counter Area */
.counter-area {
    text-align: center;
}

.current-phrase {
    font-size: 2rem;
    color: var(--text-primary);
    margin-bottom: 2rem;
    font-family: 'Amiri', serif;
    font-weight: bold;
}

.main-counter {
    margin-bottom: 2rem;
}

.counter-circle {
    position: relative;
    display: inline-block;
}

.counter-display {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 3rem;
    font-weight: bold;
    color: var(--primary-color);
}

/* Counter Controls */
.counter-controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
}

.main-counter-btn {
    background: linear-gradient(135deg, var(--primary-color), #1e40af);
    color: white;
    border: none;
    border-radius: 3rem;
    padding: 1.5rem 3rem;
    font-size: 1.2rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: var(--shadow-lg);
}

.main-counter-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 15px 30px rgba(59, 130, 246, 0.4);
}

.main-counter-btn:active {
    transform: translateY(0);
}

.secondary-controls {
    display: flex;
    gap: 1rem;
}

.secondary-btn {
    background: var(--card-bg);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    padding: 0.75rem 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.secondary-btn:hover {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

/* Responsive */
@media (max-width: 768px) {
    .main-title {
        font-size: 1.5rem;
    }
    
    .arabic-verse {
        font-size: 1.25rem;
    }
    
    .main-counter-btn {
        padding: 1.25rem 2.5rem;
        font-size: 1.1rem;
    }
    
    .secondary-controls {
        flex-direction: column;
        width: 100%;
    }
    
    .secondary-btn {
        justify-content: center;
    }
}
</style>

<script>
// Simplified Tasbeh JavaScript
let currentCount = 0;
let selectedPhraseId = null;
let selectedPhrase = 'سبحان الله';
let todayCount = 0;
let soundEnabled = true;

// Initialize app
document.addEventListener('DOMContentLoaded', function() {
    loadTodayCount();
    selectFirstPhrase();
    updateAllDisplays();
});

// Select first phrase
function selectFirstPhrase() {
    const firstCard = document.querySelector('.phrase-card');
    if (firstCard) {
        const phrase = firstCard.getAttribute('data-phrase');
        const phraseId = firstCard.getAttribute('data-id');
        selectPhrase(phrase, phraseId, firstCard);
    }
}

// Select phrase
function selectPhrase(phrase, phraseId, element) {
    selectedPhrase = phrase;
    selectedPhraseId = phraseId;
    
    document.getElementById('currentPhrase').textContent = phrase;
    
    // Update active state
    document.querySelectorAll('.phrase-card').forEach(card => {
        card.classList.remove('active');
    });
    
    if (element) {
        element.classList.add('active');
    }
    
    // Reset counter for new phrase
    currentCount = 0;
    updateCounterDisplay();
    updateProgress();
    
    playSelectionSound();
}

// Increment counter
function incrementCounter() {
    currentCount++;
    todayCount++;
    
    updateCounterDisplay();
    updateTodayDisplay();
    updateProgress();
    saveTodayCount();
    
    // Server update
    updateServerCount();
    
    playCountSound();
    addButtonEffect();
}

// Update counter display
function updateCounterDisplay() {
    const counterElement = document.getElementById('counterDisplay');
    if (counterElement) {
        counterElement.style.transform = 'scale(1.2)';
        counterElement.textContent = currentCount;
        
        setTimeout(() => {
            counterElement.style.transform = 'scale(1)';
        }, 150);
    }
}

// Update today's count
function updateTodayDisplay() {
    const todayElement = document.getElementById('todayCount');
    if (todayElement) {
        todayElement.textContent = todayCount;
    }
}

// Update all displays
function updateAllDisplays() {
    updateCounterDisplay();
    updateTodayDisplay();
    updateProgress();
}

// Update progress ring
function updateProgress() {
    const target = 33;
    const percentage = (currentCount % target) / target;
    const circumference = 2 * Math.PI * 90;
    const offset = circumference - (percentage * circumference);
    
    const progressCircle = document.getElementById('progressCircle');
    if (progressCircle) {
        progressCircle.style.strokeDashoffset = offset;
    }
}

// Server communication
function updateServerCount() {
    if (!selectedPhraseId) return;
    
    fetch('/increment-dhikr', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            phrase_id: selectedPhraseId,
            phrase: selectedPhrase
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update phrase card count
            const activeCard = document.querySelector('.phrase-card.active');
            if (activeCard) {
                const countElement = activeCard.querySelector('.phrase-count');
                if (countElement) {
                    countElement.textContent = data.count;
                }
            }
        }
    })
    .catch(error => {
        console.error('Error updating server count:', error);
    });
}

// Reset current counter
function resetCurrentCounter() {
    if (confirm('هل تريد إعادة تعيين العداد الحالي؟')) {
        currentCount = 0;
        updateCounterDisplay();
        updateProgress();
        showNotification('تم إعادة تعيين العداد');
    }
}

// Toggle sound effects
function toggleSoundEffects() {
    soundEnabled = !soundEnabled;
    updateSoundToggleUI();
    
    if (soundEnabled) {
        playTestSound();
        showNotification('تم تفعيل الأصوات');
    } else {
        showNotification('تم إيقاف الأصوات');
    }
}

// Update sound toggle UI
function updateSoundToggleUI() {
    const soundToggle = document.getElementById('soundToggle');
    if (soundToggle) {
        const icon = soundToggle.querySelector('i');
        if (soundEnabled) {
            icon.className = 'fas fa-volume-up';
            soundToggle.style.background = 'var(--success-color)';
            soundToggle.style.color = 'white';
        } else {
            icon.className = 'fas fa-volume-mute';
            soundToggle.style.background = 'var(--card-bg)';
            soundToggle.style.color = 'var(--text-primary)';
        }
    }
}

// Sound functions
function playCountSound() {
    if (!soundEnabled) return;
    
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.1);
    } catch (e) {
        console.log('Audio not supported');
    }
}

function playSelectionSound() {
    if (!soundEnabled) return;
    
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.15);
    } catch (e) {
        console.log('Audio not supported');
    }
}

function playTestSound() {
    if (!soundEnabled) return;
    
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
    } catch (e) {
        console.log('Audio not supported');
    }
}

// Visual effects
function addButtonEffect() {
    const button = document.getElementById('mainCountBtn');
    if (!button) return;
    
    button.style.transform = 'translateY(0) scale(0.95)';
    setTimeout(() => {
        button.style.transform = 'translateY(-2px) scale(1)';
    }, 100);
}

// Notification system
function showNotification(message) {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--success-color);
        color: white;
        border-radius: 0.5rem;
        padding: 1rem;
        box-shadow: var(--shadow-lg);
        z-index: 1000;
        animation: slideInRight 0.3s ease;
        direction: rtl;
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease forwards';
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Data persistence
function loadTodayCount() {
    const today = new Date().toDateString();
    const saved = localStorage.getItem(`tasbeh_${today}`);
    todayCount = saved ? parseInt(saved) : 0;
    updateTodayDisplay();
}

function saveTodayCount() {
    const today = new Date().toDateString();
    localStorage.setItem(`tasbeh_${today}`, todayCount);
}

// CSS animations
const style = document.createElement('style');
style.textContent = `
@keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}
`;
document.head.appendChild(style);
</script>
{% endblock %}
